"use strict";angular.module("abuseApp",["angularMoment","bw.paging","cfp.hotkeys","dndLists","focus-if","highcharts-ng","LocalStorageModule","ngAnimate","ngCookies","ngMaterial","ngMessages","ngResource","ngSanitize","ngTagsInput","timer","ui.router","xeditable"]).config(["$urlRouterProvider","html5BasePathProvider","$locationProvider",function(a,b,c){a.otherwise("/"),b.addTag(),c.html5Mode(!0)}]),angular.module("abuseApp").controller("TicketCtrl",["$rootScope","$scope","$stateParams","$location","$state","Tickets","Reports","Defendant","Tags","Toast","Categories","User","$mdDialog","Auth","Priorities","Status","$q","$http","Stats","$window","$timeout","Search","Proofs",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){var x=this;x.state=e,x.warningMode=!1,x.showFloatButtonComment=!1,x.loaders={report:!1,categories:!1,priorities:!1},x.selectedTabIndex=0,x.init=function(){x.getTicket().then(function(){q.all([x.getUsers(),x.getCategories(),x.getPriorities(),x.getStatus(),x.getProofs(),x.getTags(),x.getReportsProviders(),x.getCustomerTicketCount(),x.getTicketCount()]).then(function(){var a={paginate:{resultsPerPage:250,currentPage:1}};v.todoTicketList({filters:a}).$promise.then(function(a){var b=a.tickets,c=b.map(function(a){return a.id}),d=c.indexOf(x.ticket.id);d-1>=0&&(x.prevTicketId=c[d-1]),d+1<=b.length&&(x.nextTicketId=c[d+1])},function(a){j.error(a)})["finally"](function(){x.loaders.reports=!1})},function(a){j.error(a)})})},x.getUsers=function(){return x.loaders.users=!0,l.query({}).$promise.then(function(a){x.users=a,x.users.unshift({username:"nobody"})},function(a){j.error(a)})["finally"](function(){x.loaders.users=!1})},x.getTicket=function(){return x.loaders.ticket=!0,f.get({Id:c.id}).$promise.then(function(a){if(x.ticket=a,x.ticket.justAssigned&&j.success("Ticket assigned to me"),x.ticket.creationDate=new Date(1e3*x.ticket.creationDate),x.ticket.defendant&&(x.ticket.defendant.creationDate=moment(x.ticket.defendant.creationDate,"DD/MM/YY")),x.ticket.snoozeStart&&(x.ticket.snoozeStart=new Date(1e3*x.ticket.snoozeStart)),x.ticket.pauseStart&&(x.ticket.pauseStart=new Date(1e3*x.ticket.pauseStart)),-1!==["WaitingAnswer","Answered"].indexOf(x.ticket.status)&&x.ticket.snoozeStart&&x.ticket.snoozeDuration){var c=moment.tz(x.ticket.snoozeStart,"Europe/Paris");c.add(x.ticket.snoozeDuration,"seconds"),x.countdown=c.diff(moment.tz((new Date).getTime(),"Europe/Paris"),"seconds",!0),b.$broadcast("timer-set-countdown",x.countdown)}if("Paused"===x.ticket.status&&x.ticket.pauseStart&&x.ticket.pauseDuration){var d=moment.tz(x.ticket.pauseStart,"Europe/Paris");d.add(x.ticket.pauseDuration,"seconds"),x.countdownPaused=d.diff(moment.tz((new Date).getTime(),"Europe/Paris"),"seconds",!0),b.$broadcast("timer-set-countdown",x.countdownPaused)}},function(a){j.error(a)})["finally"](function(){x.loaders.ticket=!1})},x.reputationCharts={},x.getTicketCount=function(){var a={paginate:{resultsPerPage:0,currentPage:1}};return v.query({filters:JSON.stringify(a)}).$promise},x.getCustomerTicketCount=function(){if(!x.ticket.defendant)return null;var a={paginate:{resultsPerPage:0,currentPage:1},where:{like:[{defendant:[x.ticket.defendant.email]}],"in":[{status:["Open","Paused","Answered","Alarm","WaitingAnswer","Reopened"]}]}};return v.query({filters:JSON.stringify(a)}).$promise.then(function(a){x.ticketsCount=a.ticketsCount})},x.getReportsProviders=function(){x.loaders.providerReports=!0,f.providers({Id:x.ticket.id}).$promise.then(function(a){x.trustedSources=_.uniq(a.filter(function(a){return a.trusted===!0}).map(function(a){return a.email})),x.unTrustedSources=_.uniq(a.filter(function(a){return a.trusted===!1}).map(function(a){return a.email}))},function(a){j.error(a)})["finally"](function(){x.loaders.providerReports=!1})},x.filterUserProfil=function(a){return n.getCurrentUser().profiles.filter(function(a){return a.category===x.ticket.category})[0].profile===a},x.isBeginner=function(){return x.filterUserProfil("Beginner")},x.isReadOnly=function(){return x.filterUserProfil("Read-only")},x.isMyTicket=function(){return x.ticket&&x.ticket.treatedBy===n.getCurrentUser().username},x.hasTicketCountdown=function(){return"Paused"===x.ticket.status?x.countdownPaused>0:~["WaitingAnswer","Answered"].indexOf(x.ticket.status)?x.countdown>0:!1},x.getCategories=function(){return x.loaders.categories=!0,k.query().$promise.then(function(a){x.categories=a.map(function(a){return{label:a.label,name:a.name,description:a.description}})},function(a){j.error(a)})["finally"](function(){x.loaders.categories=!1})},x.getStatus=function(){return x.loaders.status=!0,p.getTicket().$promise.then(function(a){x.status=a,x.btnStatus=a.filter(function(a){return"Open"!==a.label})},function(a){j.error(a)})["finally"](function(){x.loaders.status=!1})},x.getPriorities=function(){return x.loaders.priorities=!0,o.getTickets().$promise.then(function(a){x.priorities=a},function(a){j.error(a)})["finally"](function(){x.loaders.priorities=!1})},x.getProofs=function(){return x.loaders.proofs=!0,w.query({ticketId:x.ticket.id}).$promise.then(function(a){x.proofs=a},function(a){j.error(a)})["finally"](function(){x.loaders.proofs=!1})},x.toggleConfidential=function(a){if(!x.ticket.confidential)return void x.updateTicket();var b=m.confirm().title("Are you sure to set this ticket confidential?").ok("Yes I am").cancel("No, forget about it").targetEvent(a);m.show(b).then(x.updateTicket,function(){x.ticket.confidential=!1})},x.updateTicket=function(){return x.loaders.tickets=!0,"nobody"===x.ticket.treatedBy&&(x.ticket.treatedBy=null),f.update({Id:x.ticket.id},x.ticket).$promise.then(function(b){angular.extend(x.ticket,b),x.ticket.creationDate=new Date(1e3*x.ticket.creationDate),x.ticket.defendant&&(x.ticket.defendant.creationDate=moment(x.ticket.defendant.creationDate,"DD/MM/YY")),x.ticket.snoozeStart&&(x.ticket.snoozeStart=new Date(1e3*x.ticket.snoozeStart)),x.ticket.pauseStart&&(x.ticket.pauseStart=new Date(1e3*x.ticket.pauseStart)),j.success("Ticket updated successfully"),a.$broadcast("ticketsOrReportsUpdated")},function(a){j.error(a),x.init()})["finally"](function(){x.loaders.tickets=!1})},x.showDialogDefendantComment=function(a){m.show({controller:"ReportCommentCtrl",templateUrl:"components/comments/add/comments-add.html",targetEvent:a,locals:{defaultText:""}}).then(function(a){h.addComment({id:x.ticket.defendant.id},{comment:a}).$promise.then(function(a){Array.isArray(x.ticket.defendant.comments)||(x.ticket.defendant.comments=[]),x.ticket.defendant.comments.splice(0,0,a),j.success("Comment has successfully been added.")},function(a){j.error(a)})})},x.showDialogEditDefendantComment=function(a,b){m.show({controller:"ReportCommentCtrl",templateUrl:"components/comments/add/comments-add.html",targetEvent:a,locals:{defaultText:b.comment}}).then(function(a){h.updateComment({id:x.ticket.defendant.id,idComment:b.id},{comment:a}).$promise.then(function(){b.comment=a,j.success("Comment has successfully been added.")},function(a){j.error(a)})})},x.removeDefendantComment=function(a){h.deleteComment({id:x.ticket.defendant.id,idComment:a.id}).$promise.then(function(){j.success("Comment has been successfully removed.");var b=x.ticket.defendant.comments.indexOf(a);x.ticket.defendant.comments.splice(b,1)},function(a){j.error(a)})},x.showDialogDetachDefendant=function(a){m.show({controller:"DetachDefendantCtrl",templateUrl:"app/tickets/detach-defendant/detach-defendant.html",targetEvent:a,locals:{ticket:x.ticket}}).then(function(){x.ticket.defendant=null,x.updateTicket().then(function(){x.init()})})},x.showDialogInteract=function(a){m.show({controller:"InteractDialogCtrl",templateUrl:"app/tickets/interact-dialog/interact-dialog.html",targetEvent:a,locals:{ticket:x.ticket,nextTicketId:x.nextTicketId,options:null}}).then(function(){x.init()})},x.showDialogChangeDelay=function(a){m.show({controller:"ChangeDelayCtrl",templateUrl:"app/tickets/change-delay/change-delay.html",targetEvent:a,locals:{ticket:x.ticket}}).then(function(a){f.changeDelay({Id:x.ticket.id},{snoozeDuration:a}).$promise.then(function(){j.success("Delay changed successfully"),x.init()},function(a){j.error(a)})})},x.showDialogComment=function(a){m.show({controller:"ReportCommentCtrl",templateUrl:"components/comments/add/comments-add.html",targetEvent:a,locals:{defaultText:""}}).then(function(a){f.saveComment({Id:x.ticket.id},{comment:a}).$promise.then(function(a){Array.isArray(x.ticket.comments)||(x.ticket.comments=[]),x.ticket.comments.splice(0,0,a),j.success("Comment has successfully been added.")},function(a){j.error(a)})})},x.showDialogAddProof=function(a){m.show({controller:"ProofEditCtrl",templateUrl:"app/tickets/proofs/edit/edit-proof.html",targetEvent:a}).then(function(a){w.save({ticketId:x.ticket.id},{content:a}).$promise.then(function(a){j.success(a.message),x.getProofs()},function(a){j.error(a)})})},x.showStatusButton=function(a){return a.label!==x.ticket.status},x.setPause=function(a){m.show({controller:"PauseDelayCtrl",templateUrl:"app/tickets/pause-delay/pause-delay.html",targetEvent:a,locals:{ticket:x.ticket}}).then(function(a){f.status({Id:x.ticket.id,status:"paused"},{pauseDuration:a}).$promise.then(function(){j.success("Ticket paused successfully"),x.init()},function(a){j.error(a)})})},x.setPauseDuration=function(a){m.show({controller:"PauseDelayCtrl",templateUrl:"app/tickets/pause-delay/pause-delay.html",targetEvent:a,locals:{ticket:x.ticket}}).then(function(a){f.changePauseDelay({Id:x.ticket.id},{pauseDuration:a}).$promise.then(function(){j.success("Ticket pause duration successfully"),x.init()},function(a){j.error(a)})})},x.setUnpause=function(){return x.loaders.status=!0,f.status({Id:x.ticket.id,status:"unpaused"},{pauseDuration:0}).$promise.then(function(){x.init(),a.$broadcast("ticketsOrReportsUpdated"),j.success("Ticket updated successfully")},function(a){j.error(a)})["finally"](function(){x.loaders.status=!1})},x.showDialogActionStatus=function(a){m.show({controller:"ActionStatusDialogCtrl",templateUrl:"app/tickets/action-dialog/action-dialog.html",targetEvent:a,locals:{ticketId:x.ticket.id}})},x.setStatus=function(b){return x.loaders.status=!0,f.status({Id:x.ticket.id,status:b.label.toLowerCase()},{pauseDuration:0}).$promise.then(function(){x.init(),a.$broadcast("ticketsOrReportsUpdated"),j.success("Ticket updated successfully")},function(a){j.error(a)})["finally"](function(){x.loaders.status=!1})},x.setClosed=function(b){x.loaders.status=!0,m.show({controller:"TicketResolutionCtrl",templateUrl:"app/tickets/ticket-resolution/ticket-resolution.html",targetEvent:b}).then(function(b){f.status({Id:x.ticket.id,status:"closed"},b).$promise.then(function(){a.$broadcast("ticketsOrReportsUpdated"),j.success("Ticket updated successfully"),x.init()},function(a){j.error(a)})})},x.onTabSelected=function(){u(function(){$(t).resize()},700)},b.$on("timer-stopped",function(){x.getTicket()}),x.getTags=function(){return i.query().$promise.then(function(a){x.defendantTags=a.filter(function(a){return"Defendant"===a.tagType}),x.ticketTags=a.filter(function(a){return"Ticket"===a.tagType})},function(a){j.error(a)})},x.addTicketTag=function(a){var b=x.ticketTags.filter(function(b){return b.id===a.id}).length>0;b?f.addTag({Id:x.ticket.id},a.toJSON()).$promise.then(function(){j.success("Tag added successfully")},function(a){x.init(),j.error(a)})["finally"](function(){x.loaders.tickets=!1}):i.save({name:a.name,tagType:"Ticket"}).$promise.then(function(a){x.ticketTags.push(a),x.addTicketTag(a)})},x.removeTicketTag=function(a){f.deleteTag({Id:x.ticket.id,idTag:a.id}).$promise.then(function(){_.remove(x.ticket.tags,function(b){return a.id===b.id}),j.success("Tag removed successfully")},function(a){x.init(),j.error(a)})},x.addDefendantTag=function(a){var b=x.defendantTags.filter(function(b){return b.id===a.id}).length>0;b?h.addTag({id:x.ticket.defendant.id},a.toJSON()).$promise.then(function(){j.success("Tag added successfully")},function(a){x.init(),j.error(a)}):i.save({name:a.name,tagType:"Defendant"}).$promise.then(function(a){x.defendantTags.push(a),x.addDefendantTag(a)})},x.removeDefendantTag=function(a){h.deleteTag({id:x.ticket.defendant.id,idTag:a.id}).$promise.then(function(){_.remove(x.ticket.defendant.tags,function(b){return a.id===b.id}),j.success("Tag removed successfully")},function(a){x.init(),j.error(a)})}}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("login",{url:"/login",templateUrl:"app/account/login/login.html",controller:"LoginCtrl",controllerAs:"ctrl"})}]),angular.module("abuseApp").controller("MyAccountCtrl",["Auth","Categories","$mdDialog","$mdToast",function(a,b,c,d){function e(a){d.show({template:['<md-toast class="error">',a.data||a.statusText,"</md-toast>"].join(""),hideDelay:3e3,position:"bottom right"})}var f=this;f.loaders={categories:!1},f.init=function(){f.getCategories(),f.user=a.getCurrentUser()},f.getCategories=function(){return f.loaders.categories=!0,b.query().$promise.then(function(a){f.categories=a},e)["finally"](function(){f.loaders.categories=!1})},f.showDialogPermissions=function(a){c.show({controller:"PermissionsDialogCtrl",templateUrl:"app/account/my-account/permissions-dialog/permissions-dialog.html",targetEvent:a,locals:{queues:f.categories,userPermissions:f.user.permissions}})}}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("my-account",{url:"/my-account",templateUrl:"app/account/my-account/my-account.html",authenticate:!0,controller:"MyAccountCtrl",controllerAs:"ctrl"})}]),angular.module("abuseApp").controller("PermissionsDialogCtrl",["$scope","$mdDialog","queues","userPermissions",function(a,b,c,d){a.categories=c,a.userPermissions=d,a.permissionsGrant=["r","rw","c"],a.permissions=[],a.categories.forEach(function(b){a.permissions.push({queue:b.name,queueTypes:[]})}),a.hide=function(){b.hide(a.permissions)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("AdminCtrl",["$state",function(a){var b=this;b.state=a,b.init=function(){}}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("admin",{"abstract":!0,url:"/admin",templateUrl:"app/admin/admin.html",controller:"AdminCtrl",controllerAs:"ctrl",authenticate:!0,admin:!0}).state("admin.people",{url:"/people",data:{selectedTab:0},views:{"tab-people":{templateUrl:"app/admin/people/people.html",controller:"PeopleCtrl",controllerAs:"ctrlPeople"}}}).state("admin.category",{url:"/category",data:{selectedTab:1},views:{"tab-categories":{templateUrl:"app/admin/categories/categories.html",controller:"CategoriesCtrl",controllerAs:"ctrlCategories"}}}).state("admin.providers",{url:"/sources",data:{selectedTab:2},views:{"tab-providers":{templateUrl:"app/admin/providers/providers.html",controller:"ProvidersCtrl",controllerAs:"ctrlProviders"}}}).state("admin.tags",{url:"/tags",data:{selectedTab:3},views:{"tab-tags":{templateUrl:"app/admin/tags/tags.html",controller:"TagsCtrl",controllerAs:"ctrlTags"}}}).state("admin.emails",{url:"/emails",data:{selectedTab:4},views:{"tab-emails":{templateUrl:"app/admin/emails/emails.html",controller:"EmailsCtrl",controllerAs:"ctrlEmails"}}}).state("admin.resolutions",{url:"/resolutions",data:{selectedTab:5},views:{"tab-resolutions":{templateUrl:"app/admin/resolutions/resolutions.html",controller:"ResolutionsCtrl",controllerAs:"ctrlResolutions"}}}).state("admin.presets",{url:"/presets",data:{selectedTab:6},views:{"tab-presets":{templateUrl:"app/admin/presets/presets.html",controller:"PresetsCtrl",controllerAs:"ctrlPresets"}}}).state("admin.thresholds",{url:"/thresholds",data:{selectedTab:7},views:{"tab-thresholds":{templateUrl:"app/admin/thresholds/thresholds.html",controller:"ThresholdsCtrl",controllerAs:"ctrlThresholds"}}}).state("adminUserEdit",{url:"/admin/people/edit/:userId",templateUrl:"app/admin/people/edit/user-edit.html",controller:"AdminUserEditCtrl",controllerAs:"ctrl",authenticate:!0,admin:!0})}]),angular.module("abuseApp").controller("CategoryAddCtrl",["$scope","$mdDialog",function(a,b){a.category={},a.hide=function(){b.hide(a.category)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("CategoriesCtrl",["$state","Categories","Toast","$mdDialog",function(a,b,c,d){function e(){f.getCategories()["finally"](function(){f.loaders.categories=!1})}var f=this;f.loaders={categories:!0},f.getCategories=function(){return f.loaders.categories=!0,b.query().$promise.then(function(a){f.categories=a},function(a){c.error(a)})["finally"](function(){f.loaders.categories=!1})},f.addCategory=function(a){d.show({controller:"CategoryAddCtrl",templateUrl:"app/admin/categories/add/category-add.html",targetEvent:a}).then(function(a){b.save(a).$promise.then(function(a){f.categories.push(a),c.success(["Category",a.name,"successfully added"].join(" "))},function(a){c.error(a)})},function(){})},f.updateCategory=function(a,e){d.show({controller:"CategoryUpdateCtrl",templateUrl:"app/admin/categories/update/category-update.html",targetEvent:e,locals:{category:a}}).then(function(d){f.categories=f.categories.map(function(a){return a.name===d.name?d:a}),b.update({Id:d.name},d).$promise.then(function(){c.success(["Category",a.name,"successfully updated"].join(" "))},function(a){c.error(a)})},function(){})},f.deleteCategory=function(a,e){d.show({controller:"CategoryDeleteCtrl",templateUrl:"app/admin/categories/delete/category-delete.html",targetEvent:e}).then(function(){b.remove({Id:a.name}).$promise.then(function(){_.remove(f.categories,a),c.success(["Category",a.name,"successfully removed"].join(" "))},function(a){c.error(a)})},function(){})},e()}]),angular.module("abuseApp").controller("CategoryDeleteCtrl",["$scope","$mdDialog",function(a,b){a.hide=function(){b.hide()},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("CategoryUpdateCtrl",["$scope","$mdDialog","category",function(a,b,c){a.category=angular.copy(c),a.hide=function(){b.hide(a.category)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("EmailTemplateDeleteCtrl",["$scope","$mdDialog","template",function(a,b,c){a.template=c,a.hide=function(){b.hide(a.template)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("EmailsCtrl",["$state","EmailTemplates","Toast","$mdDialog","$stateParams","$q",function(a,b,c,d,e,f){function g(){f.all([h.getEmailTemplates(),h.getEmailTemplateLanguages(),h.getRecipientTypes()])["finally"](function(){h.loaders.emails=!1})}var h=this;h.emailsTemplateView="list",h.loaders={emails:!0,emailTemplates:!0},h.getEmailTemplates=function(){return h.loaders.emailTemplates=!0,b.query().$promise.then(function(a){h.emailTemplates=a},function(a){c.error(a)})["finally"](function(){h.loaders.emailTemplates=!1})},h.getEmailTemplateLanguages=function(){return b.getLanguages().$promise.then(function(a){h.emailTemplateLanguages=a},function(a){c.error(a)})},h.getRecipientTypes=function(){return b.getRecipientTypes().$promise.then(function(a){h.recipientTypes=a},function(a){c.error(a)})},h.addEmailTemplate=function(){h.template={},h.emailsTemplateView="editor"},h.saveEmailTemplate=function(){h.template.id?b.update({Id:h.template.id},h.template).$promise.then(function(){h.emailsTemplateView="list",c.success("Template updated successfully")},function(a){c.error(a)})["finally"](function(){}):b.save(h.template).$promise.then(function(a){h.emailTemplates.push(a),h.emailsTemplateView="list",c.success("Template saved successfully")},function(a){c.error(a)})["finally"](function(){})},h.updateEmailTemplate=function(a){h.template=a,h.emailsTemplateView="editor"},h.deleteEmailTemplate=function(a,e){d.show({controller:"EmailTemplateDeleteCtrl",templateUrl:"app/admin/emails/delete/email-template-delete.html",targetEvent:a,locals:{template:e}}).then(function(){b["delete"]({Id:e.id}).$promise.then(function(){h.emailTemplates=h.emailTemplates.filter(function(a){return a.id!==e.id}),c.success(["Template",e.id,"successfully removed"].join(" "))},function(a){c.error(a)})})},g()}]),angular.module("abuseApp").controller("AdminUserEditCtrl",["$stateParams","User","Toast","Permissions","$rootScope","$q",function(a,b,c,d,e,f){var g=this;g.newPermissions={},g.allCategories={},g.loaders={user:!1,permissions:!1,categories:!1},g.init=function(){g.loaders.init=!0,f.all([g.getUser(),g.getPermissions()])["finally"](function(){g.loaders.init=!1})},g.getUser=function(){return g.loaders.user=!0,b.getUser({id:a.userId}).$promise.then(function(a){g.user=a},function(a){c.error(a)})["finally"](function(){g.loaders.user=!1})},g.getPermissions=function(){return g.loaders.permissions=!0,d.query().$promise.then(function(a){g.permissions=a},function(a){c.error(a)})["finally"](function(){g.loaders.permissions=!1})},g.selectAllCategories=function(a){var b=!g.allCategories[a.name];g.allCategories={},g.allCategories[a.name]=!b,g.user.profiles.forEach(function(c){c.profile=a.name,c.access=b})},g.isSelected=function(a,b){return a.profile===b.name&&a.access===!0},g.toggleSelection=function(a,b){a.profile=b.name,a.access=!a.access},g.savePermissions=function(){g.loaders.user=!0,b.update({id:g.user.id},g.user).$promise.then(function(a){g.user=a,e.$broadcast("user.permissions.changed"),c.success("User updated successfully")},function(a){c.error(a)})["finally"](function(){g.loaders.user=!1})}}]),angular.module("abuseApp").controller("PeopleCtrl",["$state","Auth","User","Toast",function(a,b,c,d){function e(){f.getUsers()["finally"](function(){f.loaders.users=!1})}var f=this;f.loaders={users:!0},f.getUsers=function(){return f.loaders.users=!0,c.query().$promise.then(function(a){f.users=a},function(a){d.error(a)})["finally"](function(){f.loaders.users=!1})},f["delete"]=function(a){c.remove({id:a.id}),angular.forEach(f.users,function(b,c){b===a&&f.users.splice(c,1)})},e()}]),angular.module("abuseApp").controller("PresetEditorCtrl",["$q","$mdDialog","$state","Preset","Toast","EmailTemplates","Resolution",function(a,b,c,d,e,f,g){var h=this;h.loading=!1,h.init=function(b,c){h.loading=!0,a.all([h.getResolutions(),h.getEmailTemplates(),h.getPreset(b)]).then(function(){h.loading=!1,h.parent=c})},h.getPreset=function(a){return a?d.get({Id:a}).$promise.then(function(a){h.currentPreset=a;var b=h.currentPreset.templates;h.currentPreset.templates={},b.forEach(function(a){var b=null;"Plaintiff"===a.recipientType?b="plaintiff":"Defendant"===a.recipientType?b="defendant":"Other"===a.recipientType&&(b="other"),b&&(h.currentPreset.templates[b]=a,h.currentPreset.templates[b].send=!0)}),h.currentPreset.action.params.snoozeDuration&&(h.currentPreset.action.params.snoozeDuration/=3600),h.currentPreset.action.params.pauseDuration&&(h.currentPreset.action.params.pauseDuration/=3600)},function(a){e.error(a)}):void(h.currentPreset={})},h.getResolutions=function(){return g.query().$promise.then(function(a){h.resolutions=a},function(a){e.error(a)})},h.getEmailTemplates=function(){var a={};return f.query({filters:JSON.stringify(a)}).$promise.then(function(a){h.emailTemplates=a},function(a){e.error(a)})},h.getRecipientTypes=function(){return f.getRecipientTypes().$promise.then(function(a){h.recipientTypes=a},function(a){e.error(a)})},h.getEmailTemplatesByRecipient=function(a){return h.emailTemplates.filter(function(b){return b.recipientType===a})},h.save=function(){var a=angular.copy(h.currentPreset);a.templates=[];for(var b in h.currentPreset.templates)h.currentPreset.templates[b].send&&a.templates.push(h.currentPreset.templates[b].id);a.action.params.snoozeDuration&&(a.action.params.snoozeDuration*=3600),a.action.params.pauseDuration&&(a.action.params.pauseDuration*=3600),h.loading=!0,h.currentPreset.id?d.update({Id:h.currentPreset.id},a).$promise.then(function(){h.parent.view="list",h.parent.init()},function(a){e.error(a)})["finally"](function(){h.loading=!1}):d.save(a).$promise.then(function(){h.parent.view="list",h.parent.init()},function(a){e.error(a)})["finally"](function(){h.loading=!1})}}]),angular.module("abuseApp").controller("PresetsCtrl",["$scope","$q","$mdDialog","Preset","Toast",function(a,b,c,d,e){var f=this;f.loading=!1,f.view="list",f.toBeRemoved=[],f.init=function(){f.loading=!0,b.all([f.getPresets()]).then(function(){f.loading=!1})},f.getPresets=function(){return d.query().$promise.then(function(a){f.groups=a,f.createBlankGroup()},function(a){e.error(a)})},f.addPreset=function(){f.view="adding",delete f.editingPreset},f.editPreset=function(a){f.view="editing",f.editingPreset=a.id},f.onMovePreset=function(a,b,c){if(c.presets.splice(a,1),0===c.presets.length){var d=null;if(f.groups.forEach(function(a,b){a.groupId===c.groupId&&(d=b)}),null===d)return e.error("Sorry bro, cannot determine which group this preset left :-("),!1;f.groups.splice(d,1)}f.saveOrder()},f.createBlankGroup=function(){var a=f.groups.length;0!==f.groups[a-1].presets.length&&(f.groups[a]={groupId:null,presets:[]})},f.saveOrder=function(){var a=f.groups.length;0===f.groups[a-1].presets.length&&f.groups.splice(a-1,1),d.saveOrder(f.groups).$promise.then(function(a){e.success("Modifications have been saved."),f.groups=a,f.createBlankGroup()},function(a){e.error(a)})},a.$watchCollection("ctrlPresets.toBeRemoved",function(){var a=f.toBeRemoved.pop();a&&d.remove({Id:a.id}).$promise.then(function(a){e.success("Preset has been successfully removed."),f.groups=a},function(a){e.error(a)})})}]),angular.module("abuseApp").controller("ProvidersCtrl",["$state","Providers","Categories","Toast","$mdDialog","$stateParams","$q",function(a,b,c,d,e,f,g){function h(){g.all([i.getProviders(),i.getCategories()])["finally"](function(){i.loaders.providers=!1})}var i=this;i.loaders={providers:!0},i.providersPagination={currentPage:parseInt(f.page)||1,resultsPerPage:10},i.getProviders=function(){i.loaders.providers=!0;var a={paginate:i.providersPagination};return i.searchText&&(a.paginate.currentPage=1,a.where={like:[{email:[i.searchText]}]}),b.query({filters:JSON.stringify(a)}).$promise.then(function(a){i.providers=a},function(a){d.error(a)})["finally"](function(){i.loaders.providers=!1})},i.getCategories=function(){return c.query().$promise.then(function(a){i.categories=a},function(a){d.error(a)})},i.queryProviders=function(){i.loaders.providers=!0;var a={};i.searchText&&(a.where={like:[{email:[i.searchText]}]});var c=b.query({filters:JSON.stringify(a)}).$promise;return c.then(function(a){1===a.length&&(i.selectedItem=a.providers[0],i.getProviders())}),c},i.updateProvider=function(a,b){e.show({controller:"ProviderUpdateCtrl",templateUrl:"app/admin/providers/update/provider-update.html",targetEvent:a,locals:{provider:b,categories:i.categories}}).then(function(a){i.providers.providers=_.without(i.providers.providers,b),i.providers.providers.push(a)})},i.goProvidersPage=function(a){i.providersPagination.currentPage=a,i.getProviders()},h()}]),angular.module("abuseApp").controller("ProviderUpdateCtrl",["$scope","$mdDialog","provider","categories","Priorities","Providers","Tags","Toast","$q",function(a,b,c,d,e,f,g,h,i){function j(){return a.loaders.tags=!0,g.query({tagType:"Provider"}).$promise.then(function(b){a.tags=b},function(a){h.error(a)})["finally"](function(){a.loaders.tags=!1})}function k(){return a.loaders.priorities=!0,e.getProviders().$promise.then(function(b){a.priorities=b},function(a){h.error(a)})["finally"](function(){a.loaders.priorities=!1})}a.loaders={priorities:!1,tags:!1};var l=[],m=[];a.provider=angular.copy(c),a.categories=d,a.providerHasTag=function(b){return a.provider.tags.filter(function(a){return a.id===b.id}).length>0},a.addOrRemoveProviderTag=function(b){var c=a.provider.tags.map(function(a){return a.id});c.indexOf(b.id)>-1?(_.remove(a.provider.tags,function(a){return b.id===a.id}),m.push(b)):(a.provider.tags.push(b),l.push(b))},a.hide=function(){f.update({Id:window.encodeURI(a.provider.email)},a.provider).$promise.then(function(c){l=l.map(function(b){return f.addTag({Id:a.provider.email},b).$promise}),m=m.map(function(b){return f.deleteTag({Id:a.provider.email,idTag:b.id}).$promise}),i.all(_.merge(l,m)).then(function(){b.hide(c)},function(a){h.error(a)}),h.success("Provider successfully update")},function(a){h.error(a)})},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)},k(),j()}]),angular.module("abuseApp").controller("ResolutionAddCtrl",["$scope","$mdDialog","isEditing","resolution",function(a,b,c,d){a.isEditing=c,a.resolution=d,a.hide=function(){b.hide(a.resolution)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("ResolutionsCtrl",["$q","$mdDialog","Resolution","Toast",function(a,b,c,d){var e=this;e.loading=!1,e.init=function(){e.loading=!0,a.all([e.getResolutions()]).then(function(){e.loading=!1})},e.getResolutions=function(){return c.query().$promise.then(function(a){e.resolutions=a},function(a){d.error(a)})},e.addResolution=function(a){b.show({controller:"ResolutionAddCtrl",templateUrl:"app/admin/resolutions/add/resolution-add.html",targetEvent:a,isEditing:!1,resolution:{}}).then(function(a){c.save(a).$promise.then(function(a){e.resolutions=a,d.success("Ticket resolution has been added.")},function(a){d.error(a)})})},e.updateResolution=function(a,f){b.show({controller:"ResolutionAddCtrl",templateUrl:"app/admin/resolutions/add/resolution-add.html",targetEvent:a,isEditing:!0,resolution:f}).then(function(a){c.update({Id:a.id},a).$promise.then(function(a){e.resolutions=a,d.success("Ticket resolution has been updated.")},function(a){d.error(a)})})},e.deleteResolution=function(a){c.remove({Id:a.id}).$promise.then(function(){d.success("Resolution has been successfully removed."),e.resolutions=e.resolutions.filter(function(b){return b.id!==a.id})},function(a){d.error(a)})}}]),angular.module("abuseApp").controller("DefendantTagAddCtrl",["$scope","$mdDialog","Tags","Toast","type",function(a,b,c,d,e){a.loaders={add:!1},a.tag={name:"",tagType:e,level:null},a.hide=function(){a.loaders.add=!0,c.save({},a.tag).$promise.then(function(a){b.hide(a),d.success("Tag added successfully")},function(a){d.error(a)})["finally"](function(){a.loaders.add=!1})},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("DefendantTagDeleteCtrl",["$scope","$mdDialog","Toast","Tags","tag",function(a,b,c,d,e){a.loaders={tags:!1},a.hide=function(){a.loaders.tags=!0,d["delete"]({id:e.id}).$promise.then(function(){b.hide(),c.success("Tag removed successfully")},function(a){c.error(a)})["finally"](function(){a.loaders.tags=!1})},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("TagsCtrl",["$state","Tags","Toast","$mdDialog","$stateParams","$q",function(a,b,c,d,e,f){function g(){f.all([h.getTagTypes(),h.getTags()])["finally"](function(){h.loaders.tags=!1})}var h=this;h.loaders={tags:!0},h.getTagTypes=function(){return b.types().$promise.then(function(a){h.tagTypes=a},function(a){c.error(a)})},h.getTags=function(){return b.query().$promise.then(function(a){h.tags=_.groupBy(a,"tagType")},function(a){c.error(a)})},h.addTag=function(a,b){d.show({controller:"DefendantTagAddCtrl",templateUrl:"app/admin/tags/add/tag-add.html",targetEvent:b,locals:{type:a}}).then(function(b){h.tags[a]||(h.tags[a]=[]),h.tags[a].push(b.toJSON())})},h.updateTag=function(a,b){d.show({controller:"DefendantTagUpdateCtrl",templateUrl:"app/admin/tags/update/tag-update.html",targetEvent:b,locals:{tag:a}}).then(function(a){var b=_.find(h.tags[a.tagType],function(b){return b.id===a.id});b.name=a.name,b.level=a.level})},h.deleteTag=function(a,b){d.show({controller:"DefendantTagDeleteCtrl",templateUrl:"app/admin/tags/delete/tag-delete.html",targetEvent:b,locals:{tag:a}}).then(function(){_.remove(h.tags[a.tagType],function(b){return b.id===a.id})})},g()}]),angular.module("abuseApp").controller("DefendantTagUpdateCtrl",["$scope","$mdDialog","Tags","Toast","tag",function(a,b,c,d,e){a.tag=angular.copy(e),
a.loaders={update:!1},a.hide=function(){a.loaders.update=!0,c.update({id:e.id},{name:a.tag.name,level:a.tag.level?a.tag.level:null}).$promise.then(function(a){b.hide(a),d.success("Tag updated successfully")},function(a){d.error(a)})["finally"](function(){a.loaders.update=!1})},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("ThresholdEditCtrl",["$scope","$mdDialog","categories","threshold",function(a,b,c,d){a.isEditing=!!d,a.threshold=d||{},a.categories=c,a.hide=function(){b.hide(a.threshold)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("ThresholdsCtrl",["Thresholds","Categories","Toast","$mdDialog","$q",function(a,b,c,d,e){var f=this;f.loaders={thresholds:!0},f.init=function(){e.all([f.getThresholds(),f.getCategories()])["finally"](function(){f.loaders.thresholds=!1})},f.getThresholds=function(){return f.loaders.thresholds=!0,a.query().$promise.then(function(a){f.thresholds=a},function(a){c.error(a)})["finally"](function(){f.loaders.thresholds=!1})},f.getCategories=function(){return b.query().$promise.then(function(a){f.categories=a},function(a){c.error(a)})},f.addThreshold=function(b){d.show({controller:"ThresholdEditCtrl",templateUrl:"app/admin/thresholds/edit/threshold-edit.html",targetEvent:b,locals:{categories:f.categories,threshold:null}}).then(function(b){a.save(b).$promise.then(function(a){f.thresholds.push(a),c.success(["Threshold",a.name,"successfully added"].join(" "))},function(a){c.error(a)})},function(){})},f.updateThreshold=function(b,e){d.show({controller:"ThresholdEditCtrl",templateUrl:"app/admin/thresholds/edit/threshold-edit.html",targetEvent:e,locals:{categories:f.categories,threshold:b}}).then(function(b){a.update({id:b.id},b).$promise.then(function(){c.success("Threshold successfully updated.")},function(a){c.error(a)})},function(){})},f.deleteThreshold=function(b){a.remove({id:b.id}).$promise.then(function(){_.remove(f.thresholds,b),c.success("Threshold successfully removed.")},function(a){c.error(a)})}}]),angular.module("abuseApp").controller("CampaignCtrl",["$scope","Toast","$q","$mdDialog","Categories","EmailTemplates","Campaign","Search",function(a,b,c,d,e,f,g,h){var i=this;i.view="history",i.loaders={init:!1,newForm:!1},i.init=function(){i.loaders.init=!0,i.getCampaign().then(function(){i.campaigns.forEach(function(a){i.getTicketsCount(a)}),i.loaders.init=!1})},i.getCampaign=function(){var a={sortBy:{date:-1}};return g.query({filters:a}).$promise.then(function(a){i.campaigns=a},function(a){b.error(a)})},i.getTicketsCount=function(a){var c={paginate:{resultsPerPage:0},where:{"in":[{ticketTag:[a.campaignName]}]},queryFields:["id"]};h.query({filters:c}).$promise.then(function(b){a.ticketsCount=b.ticketsCount},function(a){b.error(a)})},i.getCategories=function(){return e.query().$promise.then(function(a){i.categories=a},function(a){b.error(a)})},i.getEmailTemplates=function(){var a={where:{"in":[{recipientType:["MassContact"]}]}};return f.query({filters:a}).$promise.then(function(a){i.templates=a},function(a){b.error(a)})},i.searchTickets=function(a){var b={type:"tickets",ticketTag:a.campaignName,status:["Closed","Answered","Reopened","WaitingAnswer","Paused","ActionError"]};return["search?filters=",JSON.stringify(b)].join("")},i.enterIPs=function(a){var b=[];d.show({controller:"PasteAndParseDialogCtrl",templateUrl:"components/paste-and-parse/paste-and-parse.html",targetEvent:a,locals:{parsing:function(a){return validator.isIP(a)},formatting:function(a){return{item:a,type:"IP"}},processing:function(a){return c(function(c){b.push(a.item),c()})}}}).then(function(){i.campaignDraft.ips=b,i.ipsFieldValue=i.campaignDraft.ips.join(" ,")})},i.sendCampaign=function(){g.save(i.campaignDraft).$promise.then(function(a){console.log(a),b.success("Campaign successfully started."),i.view="history",i.init()},function(a){b.error(a)})},a.$watch("ctrl.view",function(a){"new"===a&&(i.categories?i.campaignDraft={ips:[],email:{}}:(i.loaders.newForm=!0,i.ipsFieldValue="",c.all([i.getCategories(),i.getEmailTemplates()]).then(function(){i.campaignDraft={ips:[],email:{}},i.loaders.newForm=!1})))}),a.$watch("ctrl.choosenTemplate",function(a){a&&(i.campaignDraft.email={subject:a.subject,body:a.body})})}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("campaign",{url:"/campaign",templateUrl:"app/campaign/campaign.html",authenticate:!0,controller:"CampaignCtrl",controllerAs:"ctrl"})}]),angular.module("abuseApp").controller("DashboardCtrl",["$scope","Reports","Tickets","Defendant","Status","Categories","Toast","Auth","NewsFeed","$mdDialog","$state","$stateParams","$q","$interval","$window","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this;q.tickets=[],q.news=[],q.filters=l.filters||{},q.sortBy={field:"modificationDate",order:-1},q.updateSnoozeProgressionInterval=null,q.ceil=Math.ceil,q.pagination={escalated:{currentPage:parseInt(l.page)||1,resultsPerPage:10},moderated:{currentPage:parseInt(l.page)||1,resultsPerPage:10},top20:{report:{currentPage:1,resultsPerPage:10},ticket:{currentPage:1,resultsPerPage:10}}},q.paginationNews={currentPage:1,resultsPerPage:5},q.loaders={init:!1,status:!1,tickets:!1,categories:!1,activities:!1,stats:!1,news:!1,ticketsEscalated:!1,ticketsModerated:!1,top20:!1},q.init=function(){q.loaders.init=!0,m.all([q.getStats(),q.getStatus(),q.getCategories(),q.getNews(),q.getTicketsEscalated(),q.getTicketsModerated(),q.getTopDefendants()]).then(function(){p(function(){$(o).resize()},700);var a={idle:["#8BC34A","#03A9F4","#673AB7","#FFC107","#FF9800","#795548","#607D8B","#F44336","#CDDC39"],pending:["#558B2F","#0277BD","#4527A0","#FF8F00","#EF6C00","#4E342E","#37474F","#C62828","#9E9D24"],waiting:["#AED581","#4FC3F7","#9575CD","#FFD54F","#FFB74D","#A1887F","#90A4AE","#E57373","#DCE775"]};q.chartTicketsByCategories={options:{exporting:{enabled:!1},chart:{type:"column"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,formatter:function(){return this.y>0?this.y:""},color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}}},xAxis:{categories:q.stats.categories},yAxis:{min:0,title:{text:"Nb tickets"},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},title:{text:"Tickets repartition per categories"},series:Object.keys(q.stats.ticketsByCategory).map(function(b){var c=[];for(var d in q.stats.ticketsByCategory[b])c.push({y:q.stats.ticketsByCategory[b][d],color:a[b][d]});return{name:b,data:c}}),loading:q.loaders.stats},q.reportsChart={options:{exporting:{enabled:!1},chart:{type:"pie"},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br/>',pointFormat:'<span style="color:{point.color}">{point.name}</span> : <b>{point.y}</b><br/>'}},series:[{name:"Reports",data:Object.keys(q.stats.reportsByStatus).map(function(a){return[a,q.stats.reportsByStatus[a]]})}],title:{text:"Reports repartition per status"},loading:!1},q.ticketsChart={options:{exporting:{enabled:!1},chart:{type:"pie"},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br/>',pointFormat:'<span style="color:{point.color}">{point.name}</span> : <b>{point.y}</b><br/>'}},series:[{name:"Tickets",data:Object.keys(q.stats.ticketsByStatus).map(function(a){return[a,q.stats.ticketsByStatus[a]]})}],title:{text:"Tickets repartition per status"},loading:!1}},function(a){g.error(a)})["finally"](function(){q.loaders.init=!1})},q.getStatus=function(){return q.loaders.status=!0,e.query().$promise.then(function(a){q.status=a},function(a){g.error(a)})["finally"](function(){q.loaders.status=!1})},q.getCategories=function(){return q.loaders.categories=!0,f.query().$promise.then(function(a){q.categories=a},function(a){g.error(a)})["finally"](function(){q.loaders.categories=!1})},q.getStats=function(){return q.loaders.stats=!0,b.dashboardStats().$promise.then(function(a){q.stats=a},function(a){g.error(a)})["finally"](function(){q.loaders.stats=!1})},q.getActivities=function(){return q.loaders.activities=!0,b.activities().$promise.then(function(a){q.activities=a,q.lastActivities=[],a.forEach(function(a){q.lastActivities.push({id:a._id,activity:_.max(a.history,function(a){return new Date(a.date)})})})},function(a){g.error(a)})["finally"](function(){q.loaders.activities=!1})},q.getNews=function(){return q.loaders.news=!0,i.query({filters:JSON.stringify({paginate:q.paginationNews})}).$promise.then(function(a){q.news=a},function(a){g.error(a)})["finally"](function(){q.loaders.news=!1})},q.getTicketsEscalated=function(){q.loaders.ticketsEscalated=!0;var a={};a[q.sortBy.field]=q.sortBy.order;var b={paginate:q.pagination.escalated,sortBy:a,queryFields:["id","status","creationDate","category","confidential","priority","modificationDate","defendant","snoozeDuration","snoozeStart","escalated"],where:{"in":[{escalated:[!0]}]}};c.query({filters:JSON.stringify(b)}).$promise.then(function(a){q.ticketsEscalated=a},function(a){g.error(a)})["finally"](function(){q.loaders.ticketsEscalated=!1}),c.query({filters:JSON.stringify({sortBy:a,queryFields:["id"],where:{"in":[{escalated:[!0]}]}})}).$promise.then(function(a){q.ticketsEscalatedCount=a.length},function(a){g.error(a)})["finally"](function(){q.loaders.ticketsEscalated=!1})},q.getTicketsModerated=function(){q.loaders.ticketsModerated=!0;var a={};a[q.sortBy.field]=q.sortBy.order;var b={paginate:q.pagination.moderated,sortBy:a,queryFields:["id","status","creationDate","category","confidential","priority","modificationDate","defendant","snoozeDuration","snoozeStart","escalated","moderation"],where:{"in":[{moderation:[!0]}]}};c.query({filters:JSON.stringify(b)}).$promise.then(function(a){q.ticketsModerated=a},function(a){g.error(a)})["finally"](function(){q.loaders.ticketsModerated=!1}),c.query({filters:JSON.stringify({sortBy:a,queryFields:["id"],where:{"in":[{moderation:[!0]}]}})}).$promise.then(function(a){q.ticketsModeratedCount=a.length},function(a){g.error(a)})["finally"](function(){q.loaders.ticketsModerated=!1})},q.getMyTickets=function(){q.loaders.tickets=!0;var a={};a[q.sortBy.field]=q.sortBy.order;var b={paginate:q.pagination,sortBy:a,queryFields:["id","status","creationDate","category","confidential","priority","modificationDate","defendant","snoozeDuration","snoozeStart"],where:{}};q.filters.status&&(b.where["in"]||(b.where["in"]=[]),b.where["in"].push({status:[q.filters.status]})),q.filters.category&&(b.where["in"]||(b.where["in"]=[]),b.where["in"].push({category:[q.filters.category]})),q.filters.customerId&&(b.where.like||(b.where.like=[]),b.where.like.push({defendantEmail:[q.filters.customerId]})),q.filters.id&&(b.where["in"]||(b.where["in"]=[]),b.where["in"].push({id:[q.filters.id]})),c.getMyTickets({filters:JSON.stringify(b)}).$promise.then(function(a){q.tickets=a,q.updateSnoozeProgression(),q.updateSnoozeProgressionInterval&&n.cancel(q.updateSnoozeProgressionInterval),q.updateSnoozeProgressionInterval=n(q.updateSnoozeProgression,6e4)},function(a){g.error(a)})["finally"](function(){q.loaders.tickets=!1})},q.updateSnoozeProgression=function(){q.tickets.forEach(function(a){if(a.snoozeStart&&a.snoozeDuration){var b=moment(a.snoozeStart).add(a.snoozeDuration,"h");a.snoozeProgress=Math.min(Math.round((a.snoozeDuration-b.diff(moment(),"h",!0))/a.snoozeDuration*100),100)}})},q.getTopDefendants=function(){return q.loaders.top20=!0,d.mostNoisy().$promise.then(function(a){q.top20=a},function(a){g.error(a)})["finally"](function(){q.loaders.top20=!1})},q.getTop20Page=function(a){var b=(q.pagination.top20[a].currentPage-1)*q.pagination.top20[a].resultsPerPage,c=b+q.pagination.top20[a].resultsPerPage;return q.top20[a].filter(function(a,d){return d>=b&&c>d})},q.searchByDefendant=function(a,b){return["search?filters=",JSON.stringify({type:a,customerId:b})].join("")},q.filter=function(){q.pagination.currentPage=1,q.tickets=[],q.getMyTickets()},q.searchByCategory=function(a){return["search?filters=",JSON.stringify({category:a})].join("")},q.searchMyTickets=function(){return["search?filters=",JSON.stringify({treatedBy:h.getCurrentUser().username})].join("")},q.canEditNews=function(a){return h.getCurrentUser().username===a.author||h.isAdmin()},q.getElapsedTime=function(a){var b=new Date;return new Date(b-1e3*a.date)},q.isNewsRecent=function(a){return q.getElapsedTime(a).getUTCDate()<=1},q.getFormattedElapsedTime=function(a){var b,c=q.getElapsedTime(a);if(q.isNewsRecent(a)){var d=c.getUTCHours();b=0===d?"A few minutes":c.getUTCHours()+"h"}else b=c.getUTCDate()+"d";return b},q.showDialogAddNews=function(a){j.show({controller:"DialogNewsAddCtrl",templateUrl:"components/news/dialog-news-add/dialog-news-add.html",targetEvent:a}).then(function(a){q.news.news.push(a)},function(){})},q.showDialogDeleteNews=function(a,b){j.show({controller:"DialogNewsDeleteCtrl",templateUrl:"components/news/dialog-news-delete/dialog-news-delete.html",targetEvent:a,locals:{news:b}}).then(function(){_.remove(q.news.news,b)},function(){})},q.showDialogEditNews=function(a,b){var c=angular.copy(b);j.show({controller:"DialogNewsEditCtrl",templateUrl:"components/news/dialog-news-edit/dialog-news-edit.html",targetEvent:a,locals:{news:b}}).then(function(){},function(){q.news.news=q.news.news.map(function(a){return a===b?c:a})})},a.$watch(function(){return q.filters},function(){angular.equals({},q.filters)||q.filter()},!0),q.goPage=function(a){q.pagination.currentPage=a,q.getMyTickets()},a.$on("$destroy",function(){q.updateSnoozeProgressionInterval&&n.cancel(q.updateSnoozeProgressionInterval)})}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("dashboard",{url:"/?filters",templateUrl:"app/dashboard/dashboard.html",authenticate:!0,controller:"DashboardCtrl",controllerAs:"dashboard",reloadOnSearch:!1})}]),angular.module("abuseApp").controller("DiaporamaChangeCategoryCtrl",["$scope","Toast","Categories","$mdDialog","category",function(a,b,c,d,e){a.value={selectedCategory:e},a.init=function(){c.query().$promise.then(function(b){a.categories=b},function(a){b.error(a)})},a.cancel=function(){d.cancel()},a.save=function(){d.hide(a.value.selectedCategory)}}]),angular.module("abuseApp").controller("DiaporamaCtrl",["$scope","$location","Toast","Auth","User","Search","Reports","Defendant","$q","$mdDialog","$state","hotkeys",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this;m.skippedReports=[],m.loaders={init:!1,screenshots:!1,defendant:!1},m.init=function(){m.loaders.init=!0,m.loaders.screenshots=!0,m.loaders.defendant=!0,m.view="description",m.screenshotPage=1,delete m.currentScreenshot,m.getPhishToCheckReports().then(function(){m.report&&(b.search("report",m.report.id),i.all([m.getDefendant(),m.getScreenshots(),m.getDehtmlifiedReportBody()]))})["finally"](function(){m.loaders.init=!1})},m.getPhishToCheckReports=function(){var a={paginate:{resultsPerPage:100,currentPage:1},where:{"in":[{status:["PhishToCheck"]}]}};return f.query({filters:a}).$promise.then(function(a){var c=parseInt(b.search().report),d=a.reports.filter(function(a){return!~m.skippedReports.indexOf(a.id)});if(c){var e=!1;if(d.forEach(function(b){return b.id===c?(e=!0,m.report=b,m.reportsCount=a.reports.length,!1):void 0}),e)return}if(0===d.length)return delete m.report,m.reportsCount=d.length,void b.search("report",null);var f=Math.floor(Math.random()*d.length);m.report=d[f],m.reportsCount=d.length},function(a){c.error(a)})},m.getDefendant=function(){return m.report.defendant?h.get({id:m.report.defendant.id}).$promise.then(function(a){m.report.defendant=a,m.getDefendantTicketsAndReportsCount().then(function(){m.loaders.defendant=!1})},function(a){c.error(a)}):void(m.loaders.defendant=!1)},m.getDefendantTicketsAndReportsCount=function(){var a={paginate:{resultsPerPage:0,currentPage:1},where:{like:[{defendant:[m.report.defendant.customerId]}]}};return f.query({filters:a}).$promise.then(function(a){m.report.defendant.ticketsCount=a.ticketsCount,m.report.defendant.reportsCount=a.reportsCount},function(a){c.error(a)})},m.getScreenshots=function(){return m.loaders.screenshots=!0,g.screenshots({Id:m.report.id}).$promise.then(function(a){m.screenshots=a,m.loaders.screenshots=!1},function(a){c.error(a)})},m.getDehtmlifiedReportBody=function(){return g.dehtmlify({Id:m.report.id}).$promise.then(function(a){m.report.body=a.dehtmlify},function(a){c.error(a)})},m.changeCategory=function(a){j.show({controller:"DiaporamaChangeCategoryCtrl",templateUrl:"app/diaporama/change-category/change-category.html",targetEvent:a,locals:{category:m.report.category}}).then(function(a){var b={id:m.report.id,status:"Phishing"!==a?"New":"PhishToCheck",category:a};g.update({Id:m.report.id},b).$promise.then(function(){m.init()},function(a){c.error(a)})})},m.skipReport=function(){m.skippedReports.push(m.report.id),m.init()},m.showScreenshot=function(a){m.view="screenshot",m.showHeadersOf=null,m.screenshotHistoryIndex=0,m.currentScreenshot=a},m.exitScreenshotView=function(){m.view="description",delete m.currentScreenshot},m.isPhishing=function(a){m.currentScreenshot.isPhishing=a,m.currentScreenshot.screenshots.length>0?m.currentScreenshot.screenshotId=m.currentScreenshot.screenshots[m.screenshotHistoryIndex].screenshotId:m.currentScreenshot.screenshotId=null;var b=null;return m.screenshots.forEach(function(a){return"undefined"==typeof a.isPhishing?(b=a,!1):void 0}),b?void m.showScreenshot(b):void m.sendUserFeedback()},m.sendUserFeedback=function(){var a=!1,b=_.chain(m.screenshots).map(function(b){return a|=b.isPhishing,{screenshotId:b.screenshotId,feedback:b.isPhishing}}).value();j.show({clickOutsideToClose:!1,template:'<md-dialog>  <md-dialog-content class="md-dialog-content">    <p>'+(a?"At least one item is phishing, report is being automatically processed.":"No item are phishing, this report will be automatically archived.")+'    </p>    <md-progress-linear md-mode="indeterminate"></md-progress-linear>  </md-dialog-content></md-dialog>'}),g.giveFeedback({Id:m.report.id},b).$promise.then(function(a){c.success(a.message),m.init()},function(a){c.error(a)})["finally"](function(){j.hide()})},l.bindTo(a).add({combo:"y",description:"This screenshot is phishing.",callback:function(){"screenshot"===m.view&&m.isPhishing(!0)}}).add({combo:"n",description:"This screenshot is not phishing.",callback:function(){"screenshot"===m.view&&m.isPhishing(!1)}})}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("diaporama",{url:"/diaporama",templateUrl:"app/diaporama/diaporama.html",authenticate:!0,controller:"DiaporamaCtrl",controllerAs:"ctrl"})}]),angular.module("abuseApp").controller("AppCtrl",["$rootScope","$scope","$state","Auth","$location",function(a,b,c,d,e){b.Auth=d,b.backState="dashboard",b.previousState="dashboard",b.previousStateParams={},b.toggleMenu=function(){a.$broadcast("toggleMenu")},b.logout=function(){d.logout(),e.path("login")},b.goBack=function(){window.history.back()},b.goBackState=function(){c.go(b.previousState,b.previousStateParams)},b.goTo=function(a){e.path(a)},b.$on("$stateChangeSuccess",function(a,c,d,e,f){""!==e.name&&0!==e.name.indexOf("admin.")&&(b.backState=e.url,b.previousState=e.name,b.previousStateParams=f)})}]),angular.module("abuseApp").controller("ReportContentCtrl",["$scope","$stateParams","Reports","Toast","$mdDialog","$q","$http","URLS",function(a,b,c,d,e,f,g,h){var i=this;i.showRaw=!1,i.showDehtmlify=!1,i.currentPageItems=1,i.resultsItemsPerPage=5,i.round=Math.round;var j=a.ctrl;i.loaders={init:!1,report:!1,services:!1,categories:!1,status:!1,stats:!1,reportsHistoryForDefenfant:!1},i.init=function(){i.loaders.init=!0,f.all([i.getReportAttachments()]).then(function(){i.loaders.init=!1})},i.getReportAttachments=function(){return c.attachments({Id:j.report.id}).$promise.then(function(a){j.report.attachments=a.map(function(a){return a.url=[h.API,"reports",j.report.id,"attachments",a.id].join("/"),a})},function(a){d.error(a)})},i.showRawEmail=function(){j.report.raw?(i.showRaw=!0,i.showDehtmlify=!1):c.raw({Id:j.report.id}).$promise.then(function(a){j.report.raw=a.raw,i.showRaw=!0,i.showDehtmlify=!1},function(a){d.error(a)})},i.showDehtmlifyEmail=function(){j.report.dehtmlify?(i.showDehtmlify=!0,i.showRaw=!1):c.dehtmlify({Id:j.report.id}).$promise.then(function(a){j.report.dehtmlify=a.dehtmlify,i.showDehtmlify=!0,i.showRaw=!1},function(a){d.error(a)})},i.downloadAttach=function(a){i.loaders.downloadAttach=!0,g.get([h.API,"reports",j.report.id,"attachments",a.id].join("/"),{headers:{"Content-Type":a.filetype}}).then(function(b){var c=document.createElement("a");c.href="data:"+a.filetype+";base64,"+b.data,c.target="_blank",c.download=a.filename,document.body.appendChild(c),c.click(),document.body.removeChild(c)},function(a){d.error(a)})["finally"](function(){i.loaders.downloadAttach=!1})},i.showDialogReputation=function(a,b){e.show({controller:"ReputationDialogCtrl",templateUrl:"app/tickets/reputation-dialog/reputation-dialog.html",targetEvent:a,locals:{item:b}})}}]),angular.module("abuseApp").controller("ReportHistoryCtrl",["$scope","$stateParams","Reports","Toast","$mdDialog","$q","Stats",function(a,b,c,d,e,f,g){var h=this;h.paginationReportsHistory={currentPage:1,resultsPerPage:10},h.sortBy={field:"receivedDate",order:-1};var i=a.ctrl;h.loaders={init:!1,history:!1,stats:!1,reportsHistoryForDefenfant:!1},h.chartConfigAllQueues={options:{exporting:{enabled:!1},chart:{type:"line"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e %Y"},title:{text:"Date"}},yAxis:{allowDecimals:!1,title:{text:"Nb reports"},min:0},loading:h.loaders.stats},h.init=function(){h.loaders.init=!0,i.report&&i.report.defendant&&i.report.defendant.customerId&&f.all([h.getReportsHistoryForDefenfant(),h.getAbuseHistory()]).then(function(){h.chartConfigAllQueues.title={text:["Abuse history for ",i.report.defendant.customerId].join("")},h.loaders.init=!1})},h.getReportsHistoryForDefenfant=function(){if(i.report.defendant){h.loaders.reportsHistoryForDefenfant=!0;var a={};a[h.sortBy.field]=h.sortBy.order;var b={paginate:h.paginationReportsHistory,sortBy:a,queryFields:["id","status","receivedDate","category","provider","defendant"],where:{"in":[{defendantEmail:[i.report.defendant.email]}]}};f.all([c.query({filters:JSON.stringify(b)}).$promise,c.query({filters:JSON.stringify({queryFields:["id"],where:{"in":[{defendantEmail:[i.report.defendant.email]}]}})}).$promise]).then(function(a){h.reportsHistoryForDefenfant=a[0].filter(function(a){return a.id!==i.report.id}),h.reportsHistoryForDefenfantCount=a[1].length-1},function(a){d.error(a)})["finally"](function(){h.loaders.reportsHistoryForDefenfant=!1})}},h.getAbuseHistory=function(){return h.loaders.stats=!0,g.reports({customerId:i.report.defendant.customerId}).$promise.then(function(a){h.chartConfigAllQueues.series=a},function(a){d.error(a)})["finally"](function(){h.loaders.stats=!1})}}]),angular.module("abuseApp").controller("ReportCtrl",["$rootScope","$scope","$stateParams","Reports","Tickets","Defendant","Tags","Toast","Categories","Status","User","$mdDialog","Auth","Stats","Search","$state","$timeout","$q",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s=this;s.state=p,s.loaders={init:!1,report:!1,services:!1,categories:!1,status:!1,reportsHistoryForDefenfant:!1},s.init=function(){s.loaders.init=!0,r.all([s.getReport(),s.getUsers(),s.getCategories(),s.getStatus(),s.getTags(),s.getReportCount()]).then(function(){var a=arguments[0][5],b={paginate:{resultsPerPage:a.reportsCount,currentPage:1},queryFields:["id"],where:{"in":[{status:["New","Attached","Validated","ToValidate"]}]}};d.query({filters:JSON.stringify(b)}).$promise.then(function(a){var b=a.map(function(a){return a.id}),c=b.indexOf(s.report.id);c-1>=0&&(s.prevReportId=b[c-1]),c+1<=a.length&&(s.nextReportId=b[c+1])},function(a){h.error(a)})["finally"](function(){s.loaders.reports=!1}),!s.report.ticket&&s.report.defendant&&(b={queryFields:["id"],where:{"in":[{category:[s.report.category]},{defendantCustomerId:[s.report.defendant.customerId]},{service:[s.report.service.id]}]}},e.query({filters:JSON.stringify(b)}).$promise.then(function(a){s.hasMatchTicketToAttach=1===a.length})),s.loaders.init=!1},function(a){h.error(a)})},s.getUsers=function(){return s.loaders.users=!0,k.query({}).$promise.then(function(a){s.users=a},function(a){h.error(a)})["finally"](function(){s.loaders.users=!1})},s.getReport=function(){return s.loaders.report=!0,d.get({Id:c.id}).$promise.then(function(a){s.report=a,s.report.defendant&&(s.report.defendant.creationDate=moment(s.report.defendant.creationDate,"DD/MM/YY"))},function(a){h.error(a)})["finally"](function(){s.loaders.report=!1})},s.getReportCount=function(){var a={paginate:{resultsPerPage:0,currentPage:1}};return o.query({filters:JSON.stringify(a)}).$promise},s.getCategories=function(){return s.loaders.categories=!0,i.query().$promise.then(function(a){s.categories=a.map(function(a){return{label:a.label,name:a.name,description:a.description}})},function(a){h.error(a)})["finally"](function(){s.loaders.categories=!1})},s.getStatus=function(){return s.loaders.status=!0,j.getReport().$promise.then(function(a){s.status=a},function(a){h.error(a)})["finally"](function(){s.loaders.status=!1})},s.createTicket=function(){var a=angular.copy(s.report);delete a.items,e.save(a).$promise.then(function(){h.success("Ticket created successfully"),s.getReport().then(function(){s.report.ticket&&p.go("ticket.activities",{id:s.report.ticket})})},function(a){h.error(a)})},s.updateReport=function(){return s.loaders.reports=!0,s.report.defendant&&""===s.report.defendant.customerId&&(s.report.defendant=null),d.update({Id:s.report.id},s.report).$promise.then(function(b){s.report=b,a.$broadcast("ticketsOrReportsUpdated"),h.success("Report updated successfully")},function(a){h.error(a)})["finally"](function(){s.loaders.reports=!1})},s.showDialogDefendantComment=function(a){l.show({controller:"ReportCommentCtrl",templateUrl:"components/comments/add/comments-add.html",targetEvent:a,locals:{defaultText:""}}).then(function(a){f.addComment({id:s.report.defendant.id},{comment:a}).$promise.then(function(a){Array.isArray(s.report.defendant.comments)||(s.report.defendant.comments=[]),s.report.defendant.comments.splice(0,0,a),h.success("Comment has successfully been added.")},function(a){h.error(a)})})},s.showDialogEditDefendantComment=function(a,b){l.show({controller:"ReportCommentCtrl",templateUrl:"components/comments/add/comments-add.html",targetEvent:a,locals:{defaultText:b.comment}}).then(function(a){f.updateComment({id:s.report.defendant.id,idComment:b.id},{comment:a}).$promise.then(function(){b.comment=a,h.success("Comment has successfully been added.")},function(a){h.error(a)})})},s.removeDefendantComment=function(a){f.deleteComment({id:s.report.defendant.id,idComment:a.id}).$promise.then(function(){h.success("Comment has been successfully removed.");var b=s.report.defendant.comments.indexOf(a);s.report.defendant.comments.splice(b,1)},function(a){h.error(a)})},s.showStatusButton=function(a){return"Attached"===a.label?!s.report.ticket&&s.hasMatchTicketToAttach:a.label!==s.report.status},s.updateDefendantComment=function(){return s.loaders.reports=!0,f.addComment({id:s.report.defendant.id},{comments:s.report.defendant.comments}).$promise.then(function(){h.success("Ticket updated successfully")},function(a){s.init(),h.error(a)})["finally"](function(){s.loaders.reports=!1})},s.getTags=function(){return g.query().$promise.then(function(a){s.defendantTags=a.filter(function(a){return"Defendant"===a.tagType}),s.reportTags=a.filter(function(a){return"Report"===a.tagType})},function(a){h.error(a)})},s.addReportTag=function(a){var b=s.reportTags.filter(function(b){return b.id===a.id}).length>0;b?d.addTag({Id:s.report.id},a.toJSON()).$promise.then(function(){h.success("Tag added successfully")},function(a){s.init(),h.error(a)})["finally"](function(){s.loaders.tickets=!1}):g.save({name:a.name,tagType:"Report"}).$promise.then(function(a){s.reportTags.push(a),s.addReportTag(a)})},s.removeReportTag=function(a){d.deleteTag({Id:s.report.id,idTag:a.id}).$promise.then(function(){_.remove(s.report.tags,function(b){return a.id===b.id}),h.success("Tag removed successfully")},function(a){s.init(),h.error(a)})},s.addDefendantTag=function(a){var b=s.defendantTags.filter(function(b){return b.id===a.id}).length>0;b?f.addTag({id:s.report.defendant.id},a.toJSON()).$promise.then(function(){h.success("Tag added successfully")},function(a){s.init(),h.error(a)}):g.save({name:a.name,tagType:"Defendant"}).$promise.then(function(a){s.defendantTags.push(a),s.addDefendantTag(a)})},s.removeDefendantTag=function(a){f.deleteTag({id:s.report.defendant.id,idTag:a.id}).$promise.then(function(){_.remove(s.report.defendant.tags,function(b){return a.id===b.id}),h.success("Tag removed successfully")},function(a){s.init(),h.error(a)})},s.showDialogDetachDefendant=function(a){l.show({controller:"DetachDefendantCtrl",templateUrl:"app/tickets/detach-defendant/detach-defendant.html",targetEvent:a,locals:{ticket:s.report}}).then(function(){s.report.defendant=null,s.updateReport().then(function(){s.init()})})}}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("report",{"abstract":!0,url:"/report/{id:int}",templateUrl:"app/reports/report.html",authenticate:!0,controller:"ReportCtrl",controllerAs:"ctrl"}).state("report.content",{url:"/content",data:{selectedTab:0},views:{"tab-content":{templateUrl:"app/reports/content/content.html",controller:"ReportContentCtrl",controllerAs:"ctrlContent"}}}).state("report.services",{url:"/services",data:{selectedTab:1},views:{"tab-services":{templateUrl:"components/services/services.html",controller:"ServicesCtrl",controllerAs:"ctrlServices"}}}).state("report.history",{url:"/history",data:{selectedTab:2},views:{"tab-history":{templateUrl:"app/reports/history/history.html",controller:"ReportHistoryCtrl",controllerAs:"ctrlHistory"}}})}]),angular.module("abuseApp").controller("SearchTodoCtrl",["$scope","Tickets","Status","Categories","Priorities","$location","Toast","User","Search","$q","$mdDialog",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;l.loaders={search:!1},l.currentPage=parseInt(f.search().page)||1,l.resultsPerPage=10,l.showSearchForm=!1,l.round=Math.round,l.ceil=Math.ceil,l.selectedItems=[],l.bulk={},l.init=function(){l.loaders.search=!0,j.all([l.getTodoTickets(),l.getStatus(),l.getCategories(),l.getPriorities(),l.getUsers()]).then(function(){l.currentPage=parseInt(f.search().page)||1,l.loaders.search=!1})},l.getTodoTickets=function(){var a={paginate:{resultsPerPage:l.resultsPerPage,currentPage:l.currentPage}};return i.todoTicketList({filters:a}).$promise.then(function(a){l.results=a,f.search({page:l.currentPage}),l.results.tickets.forEach(function(a){b.getItems({Id:a.id}).$promise.then(function(b){a.items=b},function(a){g.error(a)})})},function(a){g.error(a)})},l.getStatus=function(){return l.status=[],c.getTicket().$promise.then(function(a){l.status=a},function(a){g.error(a)})},l.getCategories=function(){return d.query().$promise.then(function(a){l.categories=a},function(a){g.error(a)})},l.getUsers=function(){return h.query().$promise.then(function(a){l.users=a},function(a){g.error(a)})},l.getPriorities=function(){return e.getTickets().$promise.then(function(a){l.priorities=a},function(a){g.error(a)})},l.getElapsedTime=function(a){var b,c=new Date,d=Math.abs(c-1e3*a.modificationDate)/1e3;return b=3600>d?"A few minutes":parseInt(d/3600)+"h",b+" ago"},l.selectAllResults=function(){var a=l.results.tickets||l.results.reports;l.selectedItems=[],a.forEach(function(a){a.selected=l.selectAll,l.selectAll&&l.selectedItems.push(a.id)}),l.selectAll||l.resetBulkFields()},l.selectResultItem=function(a){var b=l.selectedItems.indexOf(a.id);~b?l.selectedItems.splice(b,1):l.selectedItems.push(a.id),0===l.selectedItems.length&&l.resetBulkFields()},l.getBulkAllowedStatus=function(){return l.status.filter(function(a){return~["Closed","Paused","Alarm","Reopened"].indexOf(a.label)})},l.resetBulkFields=function(){
l.bulk={}},l.saveBulk=function(a){var c=k.confirm().title("Are you sure to update all these "+l.selectedItems.length+" tickets?").ok("Yes I am").cancel("No, forget about it").targetEvent(a);k.show(c).then(function(){var c=function(a){b.bulk({},{tickets:l.selectedItems,properties:a}).$promise.then(function(){g.success(l.selectedItems.length+" ticket(s) successfully updated."),l.search()},function(a){g.error(a)})};if("Paused"===l.bulk.status){var d={};return d.pauseDuration=0,void k.show({controller:"PauseDelayCtrl",templateUrl:"app/tickets/pause-delay/pause-delay.html",targetEvent:a,locals:{ticket:d}}).then(function(a){l.bulk.pauseDuration=a,c(l.bulk)})}"Alarm"===l.bulk.status&&(l.bulk.alarm=!0,l.bulk.status="Unpaused"),c(l.bulk)})},l.searchTickets=function(){l.getTodoTickets()}}]),angular.module("abuseApp").controller("SearchCtrl",["$scope","Reports","Tickets","Status","Categories","Providers","Priorities","$location","Toast","Auth","User","Search","$q","Tags","$mdDialog",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){if(h.search()&&h.search().filters)try{q.filters=JSON.parse(h.search().filters),q.filters.type||(q.filters.type="tickets")}catch(a){i.error(a)}else q.filters.type="tickets"}var q=this;q.markupQL=["assignee","category","ip","priority","provider","status","url"],q.loaders={search:!1,status:!1,categories:!1,providers:!1},q.showSearchForm=!0,q.filters={},q.currentPage=parseInt(h.search().page,10)||1,q.resultsPerPage=10,q.showFilters=!0,q.sortBy={field:"creationDate",order:-1},q.round=Math.round,q.ceil=Math.ceil,q.filtersExpanded=!0,q.providerCount=0,q.searchText="",q.ql="",q.selectedItems=[],q.bulk={},q.init=function(){m.all([q.getCategories(),q.getPriorities(),q.getUsers(),q.getTags(),q.getProviderCount()]).then(function(){p(),q.currentPage=parseInt(h.search().page)||1})},q.getStatus=function(){q.loaders.status=!0,q.status=[];var a=d.query().$promise;return a="tickets"===q.filters.type?d.getTicket().$promise:d.getReport().$promise,a.then(function(a){q.status=a},function(a){i.error(a)})["finally"](function(){q.loaders.status=!1})},q.getCategories=function(){return q.loaders.categories=!0,e.query().$promise.then(function(a){q.categories=a},function(a){i.error(a)})["finally"](function(){q.loaders.categories=!1})},q.getUsers=function(){return q.loaders.users=!0,k.query().$promise.then(function(a){q.users=a},function(a){i.error(a)})["finally"](function(){q.loaders.users=!1})},q.getPriorities=function(){return q.loaders.priorities=!0,g.getTickets().$promise.then(function(a){q.priorities=a},function(a){i.error(a)})["finally"](function(){q.loaders.priorities=!1})},q.getTags=function(){return n.query().$promise.then(function(a){q.defendantTags=a.filter(function(a){return"Defendant"===a.tagType}),q.reportTags=a.filter(function(a){return"Report"===a.tagType}),q.ticketTags=a.filter(function(a){return~["Ticket","Report"].indexOf(a.tagType)})},function(a){i.error(a)})},q.searchTextChange=function(){q.searchText||(delete q.filters.providers,q.searchReports())},q.getProviderCount=function(){var a={paginate:{resultsPerPage:0,currentPage:1}};return f.query({filters:JSON.stringify(a)}).$promise.then(function(a){q.providerCount=a.providersCount},function(a){i.error(a)})},q.querySearchProvider=function(a){if(a.length<3)return[];q.loaders.reports=!0;var b={paginate:{resultsPerPage:q.providerCount,currentPage:1},queryFields:["email","trusted"],where:{like:[{email:[a]}]}};return f.query({filters:JSON.stringify(b)}).$promise.then(function(a){return a.providers},function(a){i.error(a)})["finally"](function(){q.loaders.reports=!1})},q.hasActiveFilters=function(){var a=angular.copy(q.filters);return delete a.type,q.filters&&!angular.equals({},a)},q.search=function(){switch(q.filters.status||(q.filters.status=q.status.map(function(a){return a.label}).filter(function(a){return!~["Closed","Archived"].indexOf(a)})),q.selectAll=!1,q.selectedItems=[],q.resetBulkFields(),q.filters.type){case"tickets":q.searchTickets();break;case"reports":q.searchReports();break;default:q.searchTickets()}},q.searchTickets=function(){q.loaders.search=!0,h.search("page",q.currentPage);var a={};a[q.sortBy.field]=q.sortBy.order;var b={paginate:{resultsPerPage:q.resultsPerPage,currentPage:q.currentPage||1},where:{},queryFields:["id","publicId","creationDate","modificationDate","priority","defendant","confidential","treatedBy","status","category","service","escalated","moderation"],sortBy:a};if(q.filters.ticketIds?(b.where.like||(b.where.like=[]),b.where.like.push({ticketIds:[q.filters.ticketIds.toUpperCase()]})):delete q.filters.ticketIds,q.appendQuery(b,"in","alarm",{alarm:[q.filters.alarm]}),q.appendQuery(b,"in","confidential",{confidential:[q.filters.confidential]}),q.appendQuery(b,"in","priority",{priority:[q.filters.priority]}),q.appendQuery(b,"in","ticketTag",{ticketTag:[q.filters.ticketTag]}),q.filters.hasOwnProperty("moderation")&&q.filters.moderation===!0?(b.where["in"]||(b.where["in"]=[]),b.where["in"].push({moderation:[!0]})):delete q.filters.moderation,q.filters.hasOwnProperty("escalated")&&q.filters.escalated===!0?(b.where["in"]||(b.where["in"]=[]),b.where["in"].push({escalated:[!0]})):delete q.filters.escalated,q.filters.treatedBy){b.where["in"]||(b.where["in"]=[]);var d=q.filters.treatedBy;"unassigned"===q.filters.treatedBy&&(d=null),b.where["in"].push({treatedBy:[d]})}else delete q.filters.treatedBy;q.buildCommonQuery(b),l.query({filters:JSON.stringify(b)}).$promise.then(function(a){q.results=a,h.search("filters",JSON.stringify(q.filters)),q.currentPage=h.search().page,q.results.tickets.forEach(function(a){c.getItems({Id:a.id}).$promise.then(function(b){a.items=b},function(a){i.error(a)})})},function(a){i.error(a)})["finally"](function(){q.loaders.search=!1})},q.searchReports=function(){q.loaders.search=!0,h.search("page",q.currentPage);var a={};a[q.sortBy.field]=q.sortBy.order;var c={paginate:{resultsPerPage:q.resultsPerPage,currentPage:q.currentPage||1},where:{},queryFields:["id","receivedDate","defendant","status","category","ticket","provider","reportMedia","subject","body","service"],sortBy:a};q.filters.id&&parseInt(q.filters.id,10)?(c.where["in"]||(c.where["in"]=[]),c.where["in"].push({id:[parseInt(q.filters.id,10)]})):delete q.filters.id,q.appendQuery(c,"like","subject",{subject:[q.filters.subject]}),q.appendQuery(c,"in","notAttached",{ticket:[null]}),q.appendQuery(c,"in","reportTag",{reportTag:[q.filters.reportTag]}),q.buildCommonQuery(c),l.query({filters:JSON.stringify(c)}).$promise.then(function(a){q.results=a,h.search("filters",JSON.stringify(q.filters)),q.currentPage=h.search().page,q.results.reports.forEach(function(a){b.getItems({Id:a.id}).$promise.then(function(b){a.items=b},function(a){i.error(a)})})},function(a){i.error(a)})["finally"](function(){q.loaders.search=!1})},q.buildCommonQuery=function(a){q.appendQuery(a,"like","fulltext",{fulltext:[q.filters.fulltext]}),q.appendQuery(a,"like","searchText",{body:[q.filters.searchText]}),q.appendQuery(a,"like","customerId",{defendant:[q.filters.customerId]}),q.appendQuery(a,"like","ip",{item:[q.filters.ip]}),q.appendQuery(a,"in","category",{category:q.filters.category}),q.appendQuery(a,"in","defendantTag",{defendantTag:[q.filters.defendantTag]}),q.filters.status&&q.filters.status.length>0?(a.where["in"]||(a.where["in"]=[]),a.where["in"].push({status:Array.isArray(q.filters.status)?q.filters.status:[q.filters.status]})):delete q.filters.status,q.filters.providers?(a.where["in"]||(a.where["in"]=[]),a.where["in"].push({providerEmail:[q.filters.providers.email]})):delete q.filters.providers},q.appendQuery=function(a,b,c,d){q.filters[c]?(a.where[b]||(a.where[b]=[]),a.where[b].push(d)):delete q.filters[c]},q.getElapsedTime=function(a){var b,c=new Date,d=Math.abs(c-1e3*a.modificationDate)/1e3;return b=3600>d?"A few hours":parseInt(d/3600)+"h",b+" ago"},q.selectAllResults=function(){var a=q.results.tickets||q.results.reports;q.selectedItems=[],a.forEach(function(a){a.selected=q.selectAll,q.selectAll&&q.selectedItems.push(a.id)}),q.selectAll||q.resetBulkFields()},q.selectResultItem=function(a){var b=q.selectedItems.indexOf(a.id);~b?q.selectedItems.splice(b,1):q.selectedItems.push(a.id),0===q.selectedItems.length&&q.resetBulkFields()},q.getBulkAllowedStatus=function(){return q.status.filter(function(a){return~["Closed","Paused","Alarm","Reopened"].indexOf(a.label)})},q.resetBulkFields=function(){q.bulk={}},q.saveBulk=function(a){var b=o.confirm().title("Are you sure to update all these "+q.selectedItems.length+" tickets?").ok("Yes I am").cancel("No, forget about it").targetEvent(a);o.show(b).then(function(){var b=function(a){c.bulk({},{tickets:q.selectedItems,properties:a}).$promise.then(function(){i.success(q.selectedItems.length+" ticket(s) successfully updated."),q.search()},function(a){i.error(a)})};if("Paused"===q.bulk.status){var d={};return d.pauseDuration=0,void o.show({controller:"PauseDelayCtrl",templateUrl:"app/tickets/pause-delay/pause-delay.html",targetEvent:a,locals:{ticket:d}}).then(function(a){q.bulk.pauseDuration=a,b(q.bulk)})}if("Alarm"===q.bulk.status)q.bulk.alarm=!0,q.bulk.status="Unpaused";else if("Closed"===q.bulk.status)return void o.show({controller:"TicketResolutionCtrl",templateUrl:"app/tickets/ticket-resolution/ticket-resolution.html",targetEvent:a}).then(function(a){q.bulk.resolution=a.resolution,b(q.bulk)});b(q.bulk)})},a.$watchCollection(function(){return h.search().filters},function(a,b){a!==b&&p()}),a.$watchCollection(function(){return q.filters},function(a,b){a!==b&&(q.searchText&&!q.filters.providers&&(q.searchText=""),a&&b&&a.type!==b.type?(angular.equals(b,{})||(q.filters.status=void 0,delete q.filters.status),q.currentReportPage=1,q.currentPage=1,q.getStatus().then(q.search)):q.search())})}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("search",{url:"/search?filters",templateUrl:"app/search/search.html",authenticate:!0,controller:"SearchCtrl",reloadOnSearch:!1,controllerAs:"ctrl"}).state("searchTodo",{url:"/search/todo",templateUrl:"app/search/search.html",authenticate:!0,controller:"SearchTodoCtrl",reloadOnSearch:!1,controllerAs:"ctrl"})}]),angular.module("abuseApp").controller("ActionStatusDialogCtrl",["$scope","Tickets","Toast","$mdDialog","ticketId",function(a,b,c,d,e){a.loading=!1,a.init=function(){a.loading=!0,b.getTicketJobs({Id:e}).$promise.then(function(b){a.jobs=b},function(a){c.error(a),d.cancel()})["finally"](function(){a.loading=!1})},a.cancelJob=function(a){b.cancelJob({Id:e,jobId:a.id}).$promise.then(function(a){c.success(a.message),d.cancel()},function(a){c.error(a)})},a.cancel=function(){d.cancel()},a.remove=function(){d.cancel(!0)}}]),angular.module("abuseApp").controller("TicketActivitiesCtrl",function(){var a=this;a.init=function(){a.txtFilter=""}}),angular.module("abuseApp").controller("ChangeDelayCtrl",["$scope","$mdDialog","ticket",function(a,b,c){a.snoozeDuration={value:parseInt(c.snoozeDuration/3600)},a.hide=function(){b.hide(3600*a.snoozeDuration.value)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("DetachDefendantCtrl",["$scope","$mdDialog","ticket",function(a,b,c){a.ticket=angular.copy(c),a.hide=function(){b.hide()},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("TicketEmailsCtrl",["$scope","Tickets","Toast","$q",function(a,b,c,d){var e=this,f=a.ctrl;e.emails=[],e.loaders={emails:!1},e.init=function(){d.all([e.getEmails()])},e.getEmails=function(){return e.loaders.emails=!0,b.getEmails({Id:f.ticket.id}).$promise.then(function(a){e.emails=a.map(function(a){return a.created=new Date(1e3*a.created),a}).reverse()},function(a){c.error(a)})["finally"](function(){e.loaders.emails=!1})}}]),angular.module("abuseApp").controller("TicketHistoryCtrl",["$scope","Tickets","Toast","$q","Stats",function(a,b,c,d,e){var f=this;f.paginationTicketsHistory={currentPage:1,resultsPerPage:10},f.sortBy={field:"modificationDate",order:-1};var g=a.ctrl;f.loaders={init:!1,history:!1,stats:!1,reportsHistoryForDefenfant:!1},f.chartConfigAllQueues={options:{exporting:{enabled:!1},chart:{type:"line"}},rangeSelector:{selected:1},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e %Y"},title:{text:"Date"}},yAxis:{allowDecimals:!1,title:{text:"Nb tickets"},min:0},title:{x:-20},loading:f.loaders.stats},f.chartConfigAllQueuesReports={options:{exporting:{enabled:!1},chart:{type:"line"}},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e %Y"},title:{text:"Date"}},yAxis:{allowDecimals:!1,title:{text:"Nb reports"},min:0},title:{x:-20},loading:f.loaders.stats},f.init=function(){f.loaders.init=!0,g.ticket&&g.ticket.defendant&&g.ticket.defendant.customerId&&d.all([f.getTicketsHistoryForDefenfant(),f.getAbuseHistory(),f.getStats()]).then(function(){f.chartConfigAllQueues.title={text:["Abuse tickets history for ",g.ticket.defendant.customerId].join("")},f.chartConfigAllQueuesReports.title={text:["Abuse reports history for ",g.ticket.defendant.customerId].join("")},f.loaders.init=!1})},f.getStats=function(){return f.loaders.stats=!0,e.tickets({customerId:g.ticket.defendant.customerId}).$promise.then(function(a){f.chartConfigAllQueues.series=a.map(function(a){return a.toJSON().data.forEach(function(a){var b=moment(a[0]).toDate();a[0]=Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate(),b.getUTCHours(),b.getUTCMinutes(),b.getUTCSeconds(),b.getUTCMilliseconds())}),a.toJSON()})},function(a){c.error(a)})["finally"](function(){f.loaders.stats=!1})},f.getTicketsHistoryForDefenfant=function(){if(g.ticket.defendant){f.loaders.ticketsHistoryForDefenfant=!0;var a={};a[f.sortBy.field]=f.sortBy.order;var e={paginate:f.paginationTicketsHistory,sortBy:a,queryFields:["id","status","creationDate","category","confidential","priority","modificationDate","defendant"],where:{"in":[{defendantEmail:[g.ticket.defendant.email]}]}};d.all([b.query({filters:JSON.stringify(e)}).$promise,b.query({filters:JSON.stringify({queryFields:["id"],where:{"in":[{defendantEmail:[g.ticket.defendant.email]}]}})}).$promise]).then(function(a){f.ticketsHistoryForDefenfant=a[0].filter(function(a){return a.id!==g.ticket.id}),f.ticketsHistoryForDefenfantCount=a[1].length-1},function(a){c.error(a)})["finally"](function(){f.loaders.ticketsHistoryForDefenfant=!1})}},f.getAbuseHistory=function(){return f.loaders.stats=!0,e.reports({customerId:g.ticket.defendant.customerId}).$promise.then(function(a){f.chartConfigAllQueuesReports.series=a},function(a){c.error(a)})["finally"](function(){f.loaders.stats=!1})}}]),angular.module("abuseApp").controller("InteractDialogCtrl",["$scope","$mdDialog","$q","$state","Tickets","Reports","Toast","EmailTemplates","Resolution","Preset","ticket","nextTicketId","options",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){return a.emailTemplates.filter(function(a){return a.recipientType===b})}a.ticket=k,a.loaders={init:!1,start:!1},a.recipients={},a.init=function(){a.loaders.init=!0,c.all([a.getActions(),a.getEmailTemplates(),a.getInteractionPresets(),a.getResolutions(),a.getProviders(),a.getTicketItems()]).then(function(){k.defendant&&(a.recipients.defendant=_.uniq([k.defendant.email,k.defendant.spareEmail].filter(function(a){return null!==a})),a.recipients.plaintiff=_.uniq(a.reportProviders.filter(function(a){return a&&!~a.indexOf("api:")}))),a.reset(),a.loaders.init=!1,m&&a.applyOptions()})},a.getActions=function(){return e.getActions({Id:a.ticket.id}).$promise.then(function(b){a.actions=b},function(b){g.error(b),a.cancel()})},a.getEmailTemplates=function(){return h.query().$promise.then(function(b){a.emailTemplates=b},function(a){g.error(a)})},a.getResolutions=function(){return i.query().$promise.then(function(b){a.resolutions=b},function(a){g.error(a)})},a.getInteractionPresets=function(){var b={queryFields:["id","name","codename"]};return j.query({filters:JSON.stringify(b)}).$promise.then(function(b){a.interactionPresets=b},function(a){g.error(a)})},a.getProviders=function(){var b={queryFields:["provider"],where:{"in":[{ticket:[k.id]}]}};return f.query({filters:b}).$promise.then(function(b){a.reportProviders=b.map(function(a){return a.provider.email})},function(a){g.error(a)})},a.getTicketItems=function(){return e.getItems({Id:a.ticket.id}).$promise.then(function(b){a.items=_.uniq(b.items.map(function(a){return a.history[a.history.length-1]}).filter(function(a){return"managed"===a.ipCategory}).map(function(a){var b=a.ip||a.fqdnResolved;return b}))},function(a){g.error(a)})},a.getEmailsToSend=function(){var b=Object.keys(a.data.templates);return b.filter(function(b){return a.data.templates[b].send}).sort()},a.getPlaintiffTemplates=function(){return n("Plaintiff")},a.getDefendantTemplates=function(){return n("Defendant")},a.getThirdPartyTemplates=function(){return n("Other")},a.collapseAllExcept=function(b){Object.keys(a.toggle).forEach(function(c){c===b?a.toggle[c]=!0:a.toggle[c]=!1})},a.applyOptions=function(){if(m.preset){var b=_.chain(a.interactionPresets).map(function(a){return a.presets}).flatten().find(function(a){return a.codename===m.preset}).value();if(!b)return g.error("SBL Removal preset cannot be found."),void a.cancel();a.onPresetChange(b).then(function(){["plaintiff","defendant","other"].forEach(function(b){m[b]&&Object.keys(m[b]).forEach(function(c){a.data.templates[b][c]=m[b][c]})}),m.defaultView&&a.collapseAllExcept(m.defaultView)})}},a.onPresetChange=function(b){return a.loaders.start=!0,e.getPreset({Id:a.ticket.id,presetId:b.id}).$promise.then(function(b){a.currentPreset=b,a.data=b;var c=a.data.templates;a.data.templates={},c.forEach(function(b){var c=null;"Plaintiff"===b.recipientType?c="plaintiff":"Defendant"===b.recipientType?c="defendant":"Other"===b.recipientType&&(c="other"),c&&(a.data.templates[c]=b,a.data.templates[c].send=!0,a.data.templates[c].to=b.to?b.to.join(";"):"")}),a.data.action.params.snoozeDuration&&(a.data.action.params.snoozeDuration/=3600),a.data.action.params.pauseDuration&&(a.data.action.params.pauseDuration/=3600),1===a.items.length&&(a.data.action.params.ip=a.items[0]),a.collapseAllExcept("emails")},function(a){g.error(a)})["finally"](function(){a.loaders.start=!1})},a.preRenderEmail=function(b){a.data.templates[b]&&a.data.templates[b].id&&e.preRenderEmail({Id:k.id,templateId:a.data.templates[b].id}).$promise.then(function(c){a.data.templates[b].body=c.body,a.data.templates[b].subject=c.subject,a.data.templates[b].to=c.to.join(";")},function(c){g.error(c),400===c.status&&delete a.data.templates[b].id})},a.validate=function(c){a.loaders.start=!0;var d={emails:[],action:angular.copy(a.data.action)};for(var f in a.data.templates)if(a.data.templates[f].send){var h={body:a.data.templates[f].body,subject:a.data.templates[f].subject,to:a.data.templates[f].to.split(";")};d.emails.push(h)}d.action.params.snoozeDuration&&(d.action.params.snoozeDuration*=3600),d.action.params.pauseDuration&&(d.action.params.pauseDuration*=3600),e.interact({Id:a.ticket.id},d).$promise.then(function(d){g.success(d.message),"next"===c?a.gotoNextTicket():"stay"===c&&b.hide(!0)},function(a){g.error(a)})["finally"](function(){a.loaders.start=!1})},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)},a.reset=function(){a.data={templates:{defendant:{}},action:{}},1===a.items.length&&(a.data.action.params={ip:a.items[0]}),a.toggle={presets:!0,emails:!1,preview:!1,actions:!1},delete a.currentPreset},a.gotoNextTicket=function(){d.go("ticket.activities",{id:l}),b.cancel()}}]),angular.module("abuseApp").controller("PauseDelayCtrl",["$scope","$mdDialog","ticket",function(a,b,c){a.pauseDuration={value:c.pauseDuration/3600||12},a.hide=function(){b.hide(3600*a.pauseDuration.value)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("ProofEditCtrl",["$scope","$mdDialog",function(a,b){a.hide=function(){b.hide(a.proof)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("TicketProofsCtrl",["$scope","Proofs","Toast",function(a,b,c){var d=this;d.removeProof=function(d){b.remove({ticketId:a.ctrl.ticket.id,Id:d.id}).$promise.then(function(){c.success("Proof has been successfully removed."),a.ctrl.getProofs()},function(a){c.error(a)})}}]),angular.module("abuseApp").controller("TicketReportsCtrl",["$scope","Tickets","Reports","Auth","Toast","Reputation","$q","URLS","$http","$mdDialog","$stateParams","Proofs",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this,n=a.ctrl;m.round=Math.round,m.currentReportPage=parseInt(k.page)||1,m.currentPageItems=1,m.reportResultsPerPage=5,m.resultsItemsPerPage=5,m.showRaw=!1,m.showDehtmlify=!1;var o=/<mailto:sbl-removals@spamhaus\.org\?Subject=(.*)>/;m.loaders={init:!1,reports:!1,downloadAttach:!1},m.init=function(){m.loaders.init=!0,g.all([m.getReports()])["finally"](function(){m.loaders.init=!1})},m.getReports=function(){m.loaders.reports=!0;var a={paginate:{resultsPerPage:m.reportResultsPerPage,currentPage:m.currentReportPage},where:{"in":[{ticket:[n.ticket.id]}]}};c.query({filters:JSON.stringify(a)}).$promise.then(function(a){var b=a.length;n.ticket.reports=a,n.ticket.reports.forEach(function(a){"notification@spamhaus.org"===a.provider.email&&a.body.match(o)[1]&&(a.sblRemoval={subject:a.body.match(o)[1],to:"sbl-removals@spamhaus.org"}),c.getItems({Id:a.id}).$promise.then(function(b){a.items=b},function(a){e.error(a)})["finally"](function(){b--,m.loaders.reports=!!b})})},function(a){e.error(a)})},m.getReportAttachments=function(a){return c.attachments({Id:a.id}).$promise.then(function(b){a.attachments=b.map(function(b){return b.url=[h.API,"reports",a.id,"attachments",b.id].join("/"),b})},function(a){e.error(a)})},m.downloadAttach=function(a,b){m.loaders.downloadAttach=!0,i.get([h.API,"reports",a.id,"attachments",b.id].join("/"),{headers:{"Content-Type":b.filetype}}).then(function(a){var c=document.createElement("a");c.href="data:"+b.filetype+";base64,"+a.data,c.target="_blank",c.download=b.filename,document.body.appendChild(c),c.click(),document.body.removeChild(c)},function(a){e.error(a)})["finally"](function(){m.loaders.downloadAttach=!1})},m.showRawEmail=function(a){a.raw?(m.showRaw=!0,m.showDehtmlify=!1):c.raw({Id:a.id}).$promise.then(function(b){a.raw=b.raw,m.showRaw=!0,m.showDehtmlify=!1},function(a){e.error(a)})},m.showDehtmlifyEmail=function(a){a.dehtmlify?(m.showDehtmlify=!0,m.showRaw=!1):c.dehtmlify({Id:a.id}).$promise.then(function(b){a.dehtmlify=b.dehtmlify,m.showDehtmlify=!0,m.showRaw=!1},function(a){e.error(a)})},m.detachReport=function(a){var b=function(){return a.status="New",c.update({Id:a.id},a).$promise.then(function(){n.ticket.reports=n.ticket.reports.filter(function(b){return b.id!==a.id}),e.success("Report detached successfully")},function(a){e.error(a)})["finally"](function(){n.loaders.reports=!1})};if(n.ticket.attachedReportsCount>1)b();else{var d=j.confirm({title:"Delete ticket",content:["This is the only report attached to this ticket.","If you detach this report, the ticket will be deleted."].join(" "),ok:"OK",cancel:"Cancel"});j.show(d).then(function(a){a&&b().then(function(){})})}},n.showDialogSblRemoval=function(a,b){j.show({controller:"InteractDialogCtrl",templateUrl:"app/tickets/interact-dialog/interact-dialog.html",targetEvent:b,locals:{ticket:n.ticket,nextTicketId:n.nextTicketId,options:{preset:"sbl_removal",other:a.sblRemoval,defaultView:"preview"}}}).then(function(){n.init()})},m.addProof=function(a,b){if(window.getSelection().toString()){var c={content:window.getSelection().toString().trim()};if(~window.navigator.userAgent.search(/Firefox/i)){var d=c.content.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");d=d.replace(/ /g,"[ \\r\\n]+");var f=a[b].match("("+d+")");if(!f||f.length<2)return;c.content=f[1]}l.save({ticketId:n.ticket.id},c).$promise.then(function(a){n.getProofs(),e.success(a.message)},function(a){e.error(a)})}}}]),angular.module("abuseApp").controller("ReputationDialogCtrl",["$scope","Reputation","Proofs","Toast","$mdDialog","$timeout","$filter","item","source","ticketId",function(a,b,c,d,e,f,g,h,i,j){a.rawData="",a.init=function(){b.getExternalDetails({ip:h.ip,source:i}).$promise.then(function(b){a.rawData=b,a.ticketId=j},function(a){d.error(a),e.cancel()})},a.addProof=function(a){if(window.getSelection().toString()){var b={content:window.getSelection().toString().trim()};if(~window.navigator.userAgent.search(/Firefox/i)){var e=b.content.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");e=e.replace(/ /g,"[ \\r\\n]+");var f=a.data.match("("+e+")");if(!f||f.length<2)return;b.content=f[1]}c.save({ticketId:j},b).$promise.then(function(a){d.success(a.message)},function(a){d.error(a)})}},a.cancel=function(){e.cancel()},a.remove=function(){e.cancel(!0)}}]),angular.module("abuseApp").controller("TicketResolutionCtrl",["$scope","$q","$rootScope","$mdDialog","Resolution","Tickets","Toast",function(a,b,c,d,e,f,g){a.loading=!1,a.body={},a.init=function(){a.loading=!0,b.all([a.getResolutions()]).then(function(){a.loading=!1})},a.getResolutions=function(){return e.query().$promise.then(function(b){a.resolutions=b},function(a){g.error(a)})},a.cancel=function(){d.cancel()},a.confirm=function(){d.hide(a.body)}}]),angular.module("abuseApp").controller("LoginCtrl",["$scope","Auth","$location","$window","Toast",function(a,b,c,d,e){var f=this;f.loaders={init:!1},f.errors={},f.login=function(a){f.submitted=!0,a.$valid&&b.login({name:f.user.name,password:f.user.password}).then(function(){c.path("/")})["catch"](function(a){e.error(a)})},f.loginOauth=function(a){d.location.href="/auth/"+a}}]),angular.module("abuseApp").config(["$stateProvider",function(a){a.state("ticket",{"abstract":!0,url:"/ticket/{id:int}",templateUrl:"app/tickets/ticket.html",controller:"TicketCtrl",controllerAs:"ctrl",authenticate:!0}).state("ticket.activities",{url:"/activities",data:{selectedTab:0},views:{"tab-activities":{templateUrl:"app/tickets/activities/activities.html",controller:"TicketActivitiesCtrl",controllerAs:"ctrlActivities"}}}).state("ticket.comments",{url:"/comments",data:{selectedTab:1},views:{"tab-comments":{templateUrl:"components/comments/comments.html",controller:"CommentsCtrl",controllerAs:"ctrlComments"}}}).state("ticket.reports",{url:"/reports",data:{selectedTab:2},views:{"tab-reports":{templateUrl:"app/tickets/reports/reports.html",controller:"TicketReportsCtrl",controllerAs:"ctrlReports"}}}).state("ticket.services",{url:"/services",data:{selectedTab:3},views:{"tab-services":{templateUrl:"components/services/services.html",controller:"ServicesCtrl",controllerAs:"ctrlServices"}}}).state("ticket.history",{url:"/history",data:{selectedTab:4},views:{"tab-history":{templateUrl:"app/tickets/history/history.html",controller:"TicketHistoryCtrl",controllerAs:"ctrlHistory"}}}).state("ticket.proofs",{url:"/proofs",data:{selectedTab:5},views:{"tab-proofs":{templateUrl:"app/tickets/proofs/proofs.html",controller:"TicketProofsCtrl",controllerAs:"ctrlProofs"}}}).state("ticket.emails",{url:"/emails",data:{selectedTab:6},views:{"tab-emails":{templateUrl:"app/tickets/emails/emails.html",controller:"TicketEmailsCtrl",controllerAs:"ctrlEmails"}}})}]),angular.module("abuseApp").factory("Auth",["$location","$rootScope","$http","User","$cookieStore","$q","URLS",function(a,b,c,d,e,f,g){var h={};return e.get("token")&&(h=d.get()),{login:function(a,b){var i=b||angular.noop,j=f.defer();return c.post([g.API,"auth"].join("/"),{name:a.name,password:a.password}).success(function(a){return e.put("token",a.token),h=d.get(),j.resolve(a),i()}).error(function(a){return this.logout(),j.reject(a),i(a)}.bind(this)),j.promise},logout:function(){c.post([g.API,"logout"].join("/"),{}).then(function(){e.remove("token"),h={}})},createUser:function(a,b){var c=b||angular.noop;return d.save(a,function(b){return e.put("token",b.token),h=d.get(),c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.changePassword({id:h._id},{oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},getCurrentUser:function(){return h},isLoggedIn:function(){return h.hasOwnProperty("username")},isLoggedInAsync:function(a){h.hasOwnProperty("$promise")?h.$promise.then(function(){a(!0)})["catch"](function(){a(!1)}):a(h.hasOwnProperty("role")?!0:!1)},isAdmin:function(){return h.isSuperuser===!0},getToken:function(){return e.get("token")},requestToken:function(a){var b=a||angular.noop,i=f.defer();return c.get([g.API,"auth"].join("/")).success(function(a){return e.put("token",a.token),h=d.get(),i.resolve(a),b()}).error(function(a){return this.logout(),i.reject(a),b(a)}.bind(this)),i.promise}}}]),angular.module("abuseApp").factory("User",["$resource","URLS",function(a,b){return a([b.API,"users/:id"].join("/"),{id:"@id"},{getUser:{method:"GET"},get:{method:"GET",params:{id:"me"}},update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Campaign",["$resource","URLS",function(a,b){return a([b.API,"mass-contact/:Id"].join("/"),{Id:"@Id"})}]),angular.module("abuseApp").factory("Categories",["$resource","URLS",function(a,b){return a([b.API,"categories/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Defendant",["$resource","URLS",function(a,b){return a([b.API,"defendants/:id"].join("/"),{Id:"@id"},{update:{method:"PUT"},addComment:{method:"POST",isArray:!1,url:[b.API,"defendants/:id/comments"].join("/")},updateComment:{method:"PUT",isArray:!1,url:[b.API,"defendants/:id/comments/:idComment"].join("/")},deleteComment:{method:"DELETE",isArray:!1,url:[b.API,"defendants/:id/comments/:idComment"].join("/")},addTag:{method:"POST",isArray:!1,url:[b.API,"defendants/:id/tags"].join("/")},deleteTag:{method:"DELETE",url:[b.API,"defendants/:id/tags/:idTag"].join("/")},services:{method:"GET",isArray:!0,url:[b.API,"defendants/:id/services"].join("/")},mostNoisy:{method:"GET",url:[b.API,"defendants/top20"].join("/")}})}]),angular.module("abuseApp").factory("EmailTemplates",["$resource","URLS",function(a,b){return a([b.API,"emailTemplates/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"},getRecipientTypes:{method:"GET",isArray:!0,url:[b.API,"emailTemplates/recipientsType"].join("/")},getLanguages:{method:"GET",isArray:!0,url:[b.API,"emailTemplates/languages"].join("/")}})}]),angular.module("abuseApp").factory("NewsFeed",["$resource","URLS",function(a,b){return a([b.API,"news/:id"].join("/"),{id:"@id"},{query:{isArray:!1},update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Notifications",["$resource","URLS",function(a,b){return a([b.API,"notifications"].join("/"),{})}]).service("NotificationService",["STORAGE","Auth","localStorageService","Notifications","Toast","$interval",function(a,b,c,d,e,f){function g(b){if(!b||b.key===[a.PREFIX,a.NOTIFICATIONS].join(".")){var d=angular.fromJson(c.get(a.NOTIFICATIONS));if(d&&d.length>0){var f=d.map(function(a){return a.message}).join("<br/>");e.open(f,{delay:5e3,position:"bottom left"})}}}this.pollNotifications=function(e){c.remove(a.NOTIFICATIONS),window.addEventListener("storage",g,!1),f(function(){b.isLoggedIn()&&d.query().$promise.then(function(b){b.length>0&&(c.set(a.NOTIFICATIONS,angular.toJson(b)),g())})},e||6e4)}}]),angular.module("abuseApp").factory("Permissions",["$resource","URLS",function(a,b){return a([b.API,"profiles/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Ping",["$resource","URLS",function(a,b){return a([b.API,"ping"].join("/"),{},{update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Preset",["$resource","URLS",function(a,b){return a([b.API,"presets/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"},remove:{method:"DELETE",isArray:!0},saveOrder:{method:"PUT",isArray:!0,url:[b.API,"presets/order"].join("/")}})}]),angular.module("abuseApp").factory("Priorities",["$resource","URLS",function(a,b){return a([b.API,"priorities/:id"].join("/"),{Id:"@id"},{update:{method:"PUT"},getTickets:{method:"GET",isArray:!0,url:[b.API,"priorities/ticket"].join("/")},getProviders:{method:"GET",
isArray:!0,url:[b.API,"priorities/provider"].join("/")}})}]),angular.module("abuseApp").factory("Proofs",["$resource","URLS",function(a,b){return a([b.API,"tickets/:ticketId/proof/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Providers",["$resource","URLS",function(a,b){return a([b.API,"providers/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"},addTag:{method:"POST",isArray:!1,url:[b.API,"providers/:Id/tags"].join("/")},deleteTag:{method:"DELETE",url:[b.API,"providers/:Id/tags/:idTag"].join("/")},query:{isArray:!1}})}]),angular.module("abuseApp").factory("Reports",["$resource","URLS",function(a,b){return a([b.API,"reports/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"},getItems:{method:"GET",isArray:!1,url:[b.API,"reports/:Id/items"].join("/")},createItem:{method:"POST",url:[b.API,"reports/:Id/items"].join("/")},updateItem:{method:"PUT",url:[b.API,"reports/:Id/items/:itemId"].join("/")},deleteItem:{method:"DELETE",url:[b.API,"reports/:Id/items/:itemId"].join("/")},screenshots:{method:"GET",isArray:!0,url:[b.API,"reports/:Id/items/screenshots"].join("/")},giveFeedback:{method:"POST",isArray:!1,url:[b.API,"reports/:Id/feedback"].join("/")},activities:{method:"GET",isArray:!0,url:"/api/reports/activities"},attachments:{method:"GET",isArray:!0,url:[b.API,"reports/:Id/attachments"].join("/")},raw:{method:"GET",isArray:!1,url:[b.API,"reports/:Id/raw"].join("/")},dehtmlify:{method:"GET",isArray:!1,url:[b.API,"reports/:Id/dehtmlify"].join("/")},attachment:{method:"GET",isArray:!1,url:[b.API,"reports/:Id/attachments/:attachmentId"].join("/")},addTag:{method:"POST",isArray:!1,url:[b.API,"reports/:Id/tags"].join("/")},deleteTag:{method:"DELETE",url:[b.API,"reports/:Id/tags/:idTag"].join("/")},shortcutStats:{method:"GET",url:[b.API,"toolbar"].join("/")},dashboardStats:{method:"GET",url:[b.API,"dashboard"].join("/")}})}]),angular.module("abuseApp").factory("Reputation",["$resource","URLS",function(a,b){return a([b.API,"reputation/ip/:ip/"].join("/"),{ip:"@ip"},{getRbl:{method:"GET",isArray:!0,url:[b.API,"reputation/ip/:ip/rbl"].join("/")},getInternal:{method:"GET",isArray:!0,url:[b.API,"reputation/ip/:ip/internal"].join("/")},getExternal:{method:"GET",isArray:!0,url:[b.API,"reputation/ip/:ip/external"].join("/")},getTools:{method:"GET",isArray:!0,url:[b.API,"reputation/ip/:ip/tool"].join("/")},getExternalDetails:{method:"GET",isArray:!0,url:[b.API,"reputation/ip/:ip/external/:source"].join("/")},getURLChecks:{method:"POST",isArray:!0,url:[b.API,"reputation/url/external"].join("/")}})}]),angular.module("abuseApp").factory("Resolution",["$resource","URLS",function(a,b){return a([b.API,"resolutions/:Id"].join("/"),{Id:"@Id"},{save:{method:"POST",isArray:!0},update:{method:"PUT",isArray:!0},remove:{method:"DELETE",isArray:!0}})}]),angular.module("abuseApp").factory("Search",["$resource","URLS",function(a,b){return a([b.API,"search"].join("/"),{},{query:{isArray:!1},update:{method:"PUT",isArray:!0},todoTicketList:{method:"GET",isArray:!1,url:[b.API,"tickets/todo"].join("/")}})}]),angular.module("abuseApp").factory("Stats",["$resource","URLS",function(a,b){return a([b.API,"stats/:customerId"].join("/"),{Id:"@customerId"},{tickets:{method:"GET",url:[b.API,"stats/tickets/:customerId"].join("/"),isArray:!0},reports:{method:"GET",url:[b.API,"stats/reports/:customerId"].join("/"),isArray:!0},update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Status",["$resource","URLS",function(a,b){return a([b.API,"status/:Id"].join("/"),{Id:"@Id"},{getReport:{method:"GET",isArray:!0,params:{Id:"Report"}},getTicket:{method:"GET",isArray:!0,params:{Id:"Ticket"}},update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Tags",["$resource","URLS",function(a,b){return a([b.API,"tags/:id"].join("/"),{id:"@id"},{update:{method:"PUT"},types:{method:"GET",isArray:!0,url:[b.API,"tags/:id/types"].join("/")}})}]),angular.module("abuseApp").factory("Thresholds",["$resource","URLS",function(a,b){return a([b.API,"admin/threshold/:id"].join("/"),{id:"@id"},{update:{method:"PUT"}})}]),angular.module("abuseApp").factory("Tickets",["$resource","URLS",function(a,b){return a([b.API,"tickets/:Id"].join("/"),{Id:"@Id"},{update:{method:"PUT"},getMyTickets:{method:"GET",isArray:!0,url:[b.API,"my-tickets"].join("/")},getItems:{method:"GET",isArray:!1,url:[b.API,"tickets/:Id/items"].join("/")},createItem:{method:"POST",url:[b.API,"tickets/:Id/items"].join("/")},updateItem:{method:"PUT",url:[b.API,"tickets/:Id/items/:itemId"].join("/")},deleteItem:{method:"DELETE",url:[b.API,"tickets/:Id/items/:itemId"].join("/")},stats:{method:"GET",isArray:!1,url:"/api/tickets/stats"},providers:{method:"GET",isArray:!0,url:[b.API,"tickets/:Id/providers"].join("/")},activities:{method:"GET",isArray:!0,url:"/api/tickets/activities"},getEmails:{method:"GET",isArray:!0,url:[b.API,"tickets/:Id/emails"].join("/")},sendEmail:{method:"POST",isArray:!1,url:[b.API,"tickets/:Id/emails"].join("/")},status:{method:"PUT",isArray:!1,url:[b.API,"tickets/:Id/status/:status"].join("/")},interact:{method:"POST",isArray:!1,url:[b.API,"tickets/:Id/interact"].join("/")},getMisc:{method:"GET",isArray:!1,url:[b.API,"tickets/:Id/misc"].join("/")},preRenderEmail:{method:"GET",isArray:!1,url:[b.API,"tickets/:Id/templates/:templateId"].join("/")},getPreset:{method:"GET",isArray:!1,url:[b.API,"tickets/:Id/presets/:presetId"].join("/")},changeDelay:{method:"PATCH",isArray:!1,url:[b.API,"tickets/:Id/snoozeDuration"].join("/")},changePauseDelay:{method:"PATCH",isArray:!1,url:[b.API,"tickets/:Id/pauseDuration"].join("/")},addTag:{method:"POST",isArray:!1,url:[b.API,"tickets/:Id/tags"].join("/")},deleteTag:{method:"DELETE",url:[b.API,"tickets/:Id/tags/:idTag"].join("/")},bulk:{method:"PUT",url:[b.API,"tickets/bulk"].join("/")},getActions:{method:"GET",isArray:!0,url:[b.API,"tickets/:Id/actions/list"].join("/")},getTicketJobs:{method:"GET",isArray:!0,url:[b.API,"tickets/:Id/jobs"].join("/")},cancelJob:{method:"DELETE",isArray:!1,url:[b.API,"tickets/:Id/jobs/:jobId"].join("/")},saveComment:{method:"POST",isArray:!1,url:[b.API,"tickets/:Id/comments"].join("/")},updateComment:{method:"PUT",isArray:!1,url:[b.API,"tickets/:Id/comments/:idComment"].join("/")}})}]),angular.module("abuseApp").service("Toast",["$mdToast",function(a){var b=this;this.toastPosition={bottom:!0,top:!1,left:!1,right:!0},this.toastDelay=3e3,this.getToastPosition=function(){return Object.keys(b.toastPosition).filter(function(a){return b.toastPosition[a]}).join(" ")},this.openTmpl=function(c){a.show({templateUrl:c,hideDelay:b.toastDelay,position:b.getToastPosition()})},this.open=function(c,d){d=d||{},a.show({template:"<md-toast>"+c+"</md-toast>",hideDelay:d.delay||b.toastDelay,position:d.position||b.getToastPosition()})},this.success=function(c){a.show({template:['<md-toast class="success">',c,"</md-toast>"].join(""),hideDelay:b.toastDelay,position:b.getToastPosition()})},this.error=function(c){var d="An error occurred";c&&(c.message&&(d=c.message),c.statusText&&(d=c.statusText),c.data&&c.data.status&&(d=c.data.status),c.data&&c.data.message&&(d=c.data.message)),a.show({template:['<md-toast class="error">',d,"</md-toast>"].join(""),hideDelay:b.toastDelay,position:b.getToastPosition()})}}]),angular.module("abuseApp").factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers["X-Api-Token"]=c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/login"),c.remove("token"),b.reject(a)):b.reject(a)}}}]),angular.module("abuseApp").config(["$httpProvider",function(a){a.interceptors.push("authInterceptor"),a.defaults.useXDomain=!0,a.defaults.withCredentials=!0}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$stateChangeStart",function(a,d){c.isLoggedInAsync(function(a){d.authenticate&&!a&&b.path("/login"),d.admin&&!c.isAdmin()&&b.path("/")})})}]),angular.module("abuseApp").controller("ReportCommentCtrl",["$scope","$mdDialog","defaultText",function(a,b,c){a.comment=c||"",a.hide=function(){b.hide(a.comment)},a.cancel=function(){b.cancel()},a.remove=function(){b.cancel(!0)}}]),angular.module("abuseApp").controller("CommentsCtrl",["$scope","$state","Auth","Tickets","Reports","Toast",function(a,b,c,d,e,f){function g(){var c=null;return b.$current.includes.ticket&&a.ctrl.ticket&&(c=a.ctrl.ticket),b.$current.includes.report&&a.ctrl.report&&(c=a.ctrl.report),c}function h(){var a=null;return b.$current.includes.ticket&&(a=d),b.$current.includes.report&&(a=e),a}var i=this;i.getMe=function(){return c.getCurrentUser()},i.updateComment=function(a){var b=g(),c=h();return b&&c?void c.updateComment({Id:b.id,idComment:a.id},{comment:a.comment}).$promise.then(function(){f.success("Comment has successfully been updated.")},function(a){f.error(a)}):void f.error("An error occurred")}}]),angular.module("abuseApp").config(["$compileProvider","$logProvider","CONFIG",function(a,b,c){a.debugInfoEnabled("prod"!==c.env),b.debugEnabled("prod"!==c.env)}]),angular.module("abuseApp").run(["Highcharts",function(a){a.setOptions({global:{useUTC:!1}})}]),angular.module("abuseApp").constant("Highcharts",Highcharts).constant("HIGHCHARTS_CONFIG",{colors:["#33acff","#354291","#fd8c06","#24b994","#b92463","#5a2d7a","#0d618c","#e53232"],chart:{type:"areaspline",zoomType:"x",showAxes:!0,style:{fontFamily:"Open Sans",color:"#333"}},title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},legend:{align:"right"},xAxis:{minPadding:0,type:"datetime",lineWidth:2,minorGridLineWidth:1,lineColor:"#333",minorTickLength:0,tickLength:0,labels:{style:{color:"#333",font:"11px Open Sans, Trebuchet MS, sans-serif"}}},yAxis:{gridLineWidth:0,lineColor:"#333",minorTickLength:0,tickLength:0,lineWidth:2,labels:{style:{color:"#333",font:"11px Open Sans, Trebuchet MS, sans-serif"}}},plotOptions:{areaspline:{marker:{enabled:!1},lineWidth:1,fillOpacity:.1}}}),angular.module("abuseApp").service("HighchartsService",["Highcharts","HIGHCHARTS_CONFIG",function(a,b){this.getDefaultConfig=function(){return JSON.parse(JSON.stringify(b))}}]),angular.module("abuseApp").provider("html5BasePath",["CONFIG",function(a){var b=this,c=a.basePathRegex;this.addTag=function(){var a=b.get(),c=$(document).find("head");c.append('<base href="'+a+'"/>')},this.get=function(a){a=a||document.location.pathname;var b;return b=c?angular.isArray(c)?_.find(c,function(b){return b.test(a)}):c.test(a)?c:void 0:void 0,b?a.match(b)[0]:"/"},this.$get=function(){return{get:function(a){return b.get(a)}}}}]),angular.module("abuseApp").filter("htmlToPlainText",function(){return function(a){return a.match(/<body>([\s\S]*)<\/body>/gi)?angular.element(a.match(/<body>([\s\S]*)<\/body>/gi)[0]).text():a}}),angular.module("abuseApp").constant("LANGUAGES",[{value:"de_DE",name:"Deutsch"},{value:"en_GB",name:"English"},{value:"en_CA",name:"English (Canadian)"},{value:"en_US",name:"English (United States)"},{value:"es_ES",name:"Español"},{value:"fr_FR",name:"Français"},{value:"fr_CA",name:"Français (Canadien)"},{value:"it_IT",name:"Italiano"},{value:"lt_LT",name:"Lietuviškai"},{value:"nl_NL",name:"Nederlands"},{value:"pl_PL",name:"Polski"},{value:"pt_PT",name:"Português"},{value:"sk_SK",name:"Slovakian"},{value:"fi_FI",name:"Suomi"},{value:"cs_CZ",name:"Česky"}]),angular.module("abuseApp").config(["localStorageServiceProvider","STORAGE",function(a,b){a.setPrefix(b.PREFIX)}]),angular.module("abuseApp").config(["$mdThemingProvider",function(a){a.definePalette("white",{50:"ffffff",100:"ffffff",200:"ffffff",300:"ffffff",400:"ffffff",500:"ffffff",600:"ffffff",700:"ffffff",800:"ffffff",900:"ffffff",A100:"ffffff",A200:"ffffff",A400:"ffffff",A700:"ffffff",contrastDefaultColor:"dark",contrastDarkColors:["50","100","200","300","400","A100"],contrastLightColors:void 0}),a.theme("white").primaryPalette("white").accentPalette("blue"),a.definePalette("red",{50:"f44336",100:"f44336",200:"f44336",300:"f44336",400:"f44336",500:"f44336",600:"f44336",700:"f44336",800:"f44336",900:"f44336",A100:"f44336",A200:"f44336",A400:"f44336",A700:"f44336",contrastDefaultColor:"light",contrastDarkColors:["50","100","200","300","400","A100"],contrastLightColors:void 0}),a.theme("red").primaryPalette("red").accentPalette("white"),a.theme("default").primaryPalette("indigo").accentPalette("blue")}]),angular.module("abuseApp").controller("MenuShortcutsCtrl",["$rootScope","$scope","Reports","Auth","Toast",function(a,b,c,d,e){function f(){return b.loaders.stats=!0,c.shortcutStats().$promise.then(function(a){b.stats=a,b.loaders.stats=!1},function(a){e.error(a),b.loaders.stats=!1})}b.loaders={stats:!1},b.searchMyTickets=function(){return["search?filters=",window.encodeURI(JSON.stringify({treatedBy:d.getCurrentUser().username,status:["Open","Alarm","Reopened","Paused","Answered","WaitingAnswer","ActionError"]}))].join("")},b.searchMyTicketsAnswered=function(){return["search?filters=",window.encodeURI(JSON.stringify({treatedBy:d.getCurrentUser().username,status:["Answered"]}))].join("")},b.searchMyTicketsTodo=function(){return["search?filters=",window.encodeURI(JSON.stringify({treatedBy:d.getCurrentUser().username,status:["Open","Alarm","Reopened","ActionError"]}))].join("")},b.searchMyTicketsSleeping=function(){return["search?filters=",window.encodeURI(JSON.stringify({treatedBy:d.getCurrentUser().username,status:["WaitingAnswer","Paused"]}))].join("")},a.$on("ticketsOrReportsUpdated",f),f()}]),angular.module("abuseApp").constant("moment",moment),angular.module("abuseApp").controller("DialogNewsAddCtrl",["$scope","$mdDialog","Toast","NewsFeed","Auth",function(a,b,c,d,e){a.news={author:e.getCurrentUser().username,date:new Date},a.send=function(){d.save(a.news).$promise.then(function(a){c.success("News added successfully"),b.hide(a)},function(a){c.error(a)})},a.cancel=function(){b.cancel()}}]),angular.module("abuseApp").controller("DialogNewsDeleteCtrl",["$scope","$mdDialog","Toast","NewsFeed","news",function(a,b,c,d,e){a["delete"]=function(){d["delete"](e).$promise.then(function(a){c.success("News removed successfully"),b.hide(a)},function(a){c.error(a)})},a.cancel=function(){b.cancel()}}]),angular.module("abuseApp").controller("DialogNewsEditCtrl",["$scope","$mdDialog","Toast","NewsFeed","Auth","news",function(a,b,c,d,e,f){a.news=f||{author:e.getCurrentUser().username,date:new Date},a.send=function(){d.update({id:a.news.id},a.news).$promise.then(function(a){c.success("News updated successfully"),b.hide(a)},function(a){b.cancel(a),c.error(a)})},a.cancel=function(){b.cancel()}}]),angular.module("abuseApp").run(["NotificationService",function(a){a.pollNotifications()}]),angular.module("abuseApp").controller("PasteAndParseDialogCtrl",["$scope","Toast","$mdDialog","$timeout","$filter","parsing","formatting","processing",function(a,b,c,d,e,f,g,h){a.rawData="",a.parsedData=void 0,a.processing=!1,a.init=function(){},a.cancel=function(){c.cancel()},a.displayParsedData=function(){if(a.parsedData=[],f&&g){var b=a.rawData.split(/(\s|,|;|\[|\]|#|\(|\)|{|}|"|'|\|)/);for(var c in b)b[c]=b[c].replace(/\.$/,""),b[c].trim().length>0&&f(b[c])&&a.parsedData.push(g(b[c]))}},a.removeParsedData=function(b){for(var c in a.parsedData){var d=!0;for(var e in Object.keys(a.parsedData[c]))if(a.parsedData[c][e]!==b[e]){d=!1;break}if(d){a.parsedData.splice(c,1);break}}},a.processParsedData=function(){a.processing=!0,a.parsedData.forEach(function(a){a.status="Doing...",h(a).then(function(){a.status="Ok"},function(b){a.status=b.data.message})})},a.validate=function(){c.hide(a.parsedData)}}]),angular.module("abuseApp").controller("ReportItemsCtrl",["$scope","Tickets","Reports","Auth","Toast","Reputation","$q","URLS","$http","$mdDialog","$stateParams",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;a.ctrlItems=l;var m="";l.rbl={},l.internal={},l.external={},l.tools={},l.checks={},l.loaders={init:!1,items:!1},a.ctrlReports?(l.rootCtrl=a.ctrlReports,m="ticket"):(l.rootCtrl=a.ctrlContent,m="report"),l.init=function(){l.loaders.init=!0,g.all([l.getItems()]).then(function(){l.loaders.init=!1})},l.getService=function(){return"ticket"===m?b:c},l.getReputation=function(a){l.rbl[a]||(f.getRbl({ip:a}).$promise.then(function(b){l.rbl[a]=b},function(a){e.error(a)}),f.getInternal({ip:a}).$promise.then(function(b){l.internal[a]=b},function(a){e.error(a)}),f.getExternal({ip:a}).$promise.then(function(b){l.external[a]=b},function(a){e.error(a)}),f.getTools({ip:a}).$promise.then(function(b){l.tools[a]=b},function(a){e.error(a)}))},l.checkURL=function(a){l.checks[a]||f.getURLChecks({},{url:a}).$promise.then(function(b){l.checks[a]=b},function(a){e.error(a)})},l.getItems=function(){l.loaders.items=!0;var a={paginate:{currentPage:l.rootCtrl.currentPageItems,resultsPerPage:l.rootCtrl.resultsItemsPerPage}};return l.txtFilterItems&&(a.where={like:[{rawItem:[l.txtFilterItems]}]}),l.getService().getItems({Id:k.id,filters:JSON.stringify(a)}).$promise.then(function(a){l.items=a,l.items.items.forEach(function(a){"URL"===a.itemType&&l.checkURL(a.rawItem),angular.forEach(a.history,function(a){a.ip=a.ip||a.fqdnResolved,a.ip&&"managed"===a.ipCategory&&l.getReputation(a.ip)})})},function(a){e.error(a)})["finally"](function(){l.loaders.items=!1})},l.isReputationClean=function(a,b){return void 0===_.find(l[a][b],function(a){return a.result===!0||a.result>0})},l.showDialogReputation=function(b,c,d){var e=a.ctrl.ticket?a.ctrl.ticket.id:null;j.show({controller:"ReputationDialogCtrl",templateUrl:"app/tickets/reputation-dialog/reputation-dialog.html",targetEvent:b,locals:{item:c,source:d,ticketId:e}})},l.showDialogPasteAndParse=function(b){j.show({controller:"PasteAndParseDialogCtrl",templateUrl:"components/paste-and-parse/paste-and-parse.html",targetEvent:b,locals:{parsing:function(a){return validator.isIP(a)||validator.isURL(a)||validator.isFQDN(a)},formatting:function(a){var b={item:a};return validator.isIP(a)?b.type="IP":validator.isURL(a)?b.type="URL":validator.isFQDN(a)&&(b.type="FQDN"),b},processing:function(b){var d=a.ctrl.ticket?a.ctrl.ticket.reports[0].id:a.ctrl.report.id,e={rawItem:b.item,itemType:b.type,report:d};return c.createItem({Id:d},e).$promise}}}).then(function(){l.loaders.items=!0,l.init()})},l.removeReportItem=function(a){l.loaders.items=!0,c.deleteItem({Id:a.report,itemId:a.id}).$promise.then(function(){l.items={items:l.items.items.filter(function(b){return b.id!==a.id}),itemsCount:l.items.itemsCount-1},e.success("Item removed successfully")},function(a){e.error(a)})["finally"](function(){l.loaders.items=!1})},l.updateReportItem=function(b){l.loaders.items=!0;var c=a.ctrl.ticket?a.ctrl.ticket.id:a.ctrl.report.id;l.getService().updateItem({Id:c,itemId:b.id},b).$promise.then(function(a){b=a,e.success("Item updated successfully")},function(a){e.error(a)})["finally"](function(){l.loaders.items=!1})},l.addNewReportItemMode=function(){l.newItem={itemType:"None",rawItem:"Enter value"},l.addItemMode=!0},l.addNewReportItem=function(){if(l.newItem){var d=!0;switch(l.newItem.itemType){case"IP":d=validator.isIP(l.newItem.rawItem);break;case"URL":d=validator.isURL(l.newItem.rawItem);break;case"FQDN":d=validator.isFQDN(l.newItem.rawItem)}if(!d)return void e.error({message:"The item type is wrong"});l.loaders.items=!0;var f=a.ctrl.ticket?a.ctrl.ticket.reports[0].id:a.ctrl.report.id;c.createItem({Id:f},l.newItem).$promise.then(function(){e.success("Item added successfully"),l.newItem=null,l.addItemMode=!1,l.init(),a.ctrl.ticket&&!a.ctrl.ticket.defendant?b.get({Id:k.id}).$promise.then(function(b){a.ctrl.ticket=b}):a.ctrl.report&&!a.ctrl.report.defendant&&c.get({Id:k.id}).$promise.then(function(b){a.ctrl.report=b})},function(a){e.error(a)})["finally"](function(){l.loaders.items=!1})}},l.rootCtrl.addReportItem=function(a){if(window.getSelection().toString()){var b=window.getSelection().toString().trim(),d=[];b.split("\n").forEach(function(b){b=b.trim().replace(/\[\.\]/g,".").replace(/hxxp/i,"http").replace(/httpx/i,"https").replace(/\s/g,"");var f="";if(validator.isIP(b))f="IP";else if(validator.isURL(b))f="URL";else{if(!validator.isFQDN(b))return void e.error({message:"Unable to determine the type of item"});f="FQDN"}var g={rawItem:b,itemType:f,report:a.id};d.push(c.createItem({Id:a.id},g).$promise)}),l.loaders.items=!0,d.length>0&&g.all(d).then(function(){e.success("Item added successfully"),l.init()},function(a){e.error(a)})["finally"](function(){l.loaders.items=!1})}}}]),angular.module("abuseApp").controller("ServicesCtrl",["$scope","$state","Toast","$q","Defendant",function(a,b,c,d,e){function f(a,b){return Math.round(Math.abs(+a-+b)/864e5)}var g=this,h=a.ctrl;g.loaders={init:!1,services:!1},g.defendant=null,b.$current.includes.ticket&&a.ctrl.ticket&&(g.defendant=a.ctrl.ticket.defendant,g.data=a.ctrl.ticket),b.$current.includes.report&&a.ctrl.report&&(g.defendant=a.ctrl.report.defendant,g.data=a.ctrl.report),g.init=function(){g.loaders.init=!0,g.defendant&&g.defendant.customerId&&d.all([g.getServices()]).then(function(){g.loaders.init=!1})},g.getServices=function(){return g.loaders.services=!0,e.services({id:g.defendant.customerId}).$promise.then(function(a){g.customerServices={group:{},services:{},count:{},expired:{},notValidated:{}},h.servicesCount=0,_.each(a,function(a){var b=a.zone;g.customerServices.group[b]=_.chain(a.services).map(function(a){return a.componentType}).uniq().value(),g.customerServices.services[b]={},_.each(g.customerServices.group[b],function(c){var d=_.filter(a.services,function(a){return a.componentType===c});g.customerServices.services[b][c]=d}),g.customerServices.count[b]=_.chain(g.customerServices.services[b]).values().flatten().value().length,h.servicesCount+=g.customerServices.count[b],g.customerServices.expired[b]=_.chain(g.customerServices.services[b]).values().flatten().filter(function(a){return a.expirationDate!==a.creationDate}).filter(function(a){return a.isExpired=new Date(1e3*a.expirationDate)<new Date,new Date(1e3*a.expirationDate)<new Date}).groupBy("componentType").value(),_.each(g.customerServices.expired[b],function(a,c){var d=0;a.forEach(function(a){new Date(a.expirationDate)>=g.data.creationDate&&(g.customerServices.expired[b][c].expiredSinceAbuse=g.customerServices.expired[b][c].expiredSinceAbuse+1),a.expirationDate===a.creationDate?g.customerServices.notValidated[b]++:d+=f(1e3*a.expirationDate,1e3*a.creationDate)}),d>0&&(g.customerServices.expired[b][c].avg=Math.round(d/a.length))})})},function(a){c.error(a)})["finally"](function(){g.loaders.services=!1})}}]),angular.module("abuseApp").directive("tooltipMouse",[function(){return{restrict:"EA",require:"?id",scope:{tooltipMouseZoneClass:"@",tooltipMouseDisabled:"=",tooltipMouseReposition:"&",tooltipMouseClose:"&"},link:function(a,b){function c(){b.is(".tooltip-mouse-menu-show")&&a.tooltipMouseClose&&(b.removeClass("tooltip-mouse-menu-show"),setTimeout(function(){window.getSelection&&!window.getSelection().toString().length&&a.tooltipMouseClose()},200))}b.addClass("tooltip-mouse-menu"),$(window.document).on("mouseup",function(d){if(!$(d.target).parents(".tooltip-mouse-menu").is($(b))&&!a.tooltipMouseDisabled)if(window.getSelection&&window.getSelection().toString().length){if(a.tooltipMouseZoneClass&&!$(window.getSelection().focusNode).parents("."+a.tooltipMouseZoneClass).length)return;b.is(".tooltip-mouse-menu-show")&&a.tooltipMouseReposition&&a.tooltipMouseReposition();var e=d.clientX,f=d.clientY;b.css("top",f+10-$(b).parent().offset().top+$(b).parent().scrollTop()).css("left",e-$(b).parent().offset().left+$(b).parent().scrollLeft()).addClass("tooltip-mouse-menu-show")}else c()}),$(window.document).on("keyup",function(){window.getSelection&&!window.getSelection().toString().length&&c()}),a.$watch("tooltipMouseDisabled",function(a){a&&c()})}}}]),angular.module("abuseApp").run(["validator",function(a){a.extend("isIPBlock",function(b,c){if(4===c||6===c){var d=b.split("/");return 2===d.length&&a.isIP(d[0],c)&&parseInt(d[1],10)>0&&parseInt(d[1],10)<=(4===c?32:128)}return a.isIPBlock(b,4)||a.isIPBlock(b,6)})}]),angular.module("abuseApp").constant("validator",validator),angular.module("abuseApp").run(["editableOptions","editableThemes",function(a,b){a.theme="default",b["default"].submitTpl=['<button style="background:none;border:none" type="submit">','<i class="zmdi zmdi-check success zmd-2x"></i>',"</button>"].join(""),b["default"].cancelTpl=['<button style="background:none;border:none" ng-click="$form.$cancel()">','<i class="zmdi zmdi-close error zmd-2x"></i>',"</button>"].join("")}]),angular.module("abuseApp").constant("CONFIG",{env:"production",basePathRegex:void 0}).constant("URLS",{API:"/api"}),angular.module("abuseApp").constant("STORAGE",{PREFIX:"ABUSE",NOTIFICATIONS:"APP_NOTIFICATIONS"}),angular.module("abuseApp").constant("VERSION","0.2.18"),angular.module("abuseApp").run(["$templateCache",function(a){a.put("components/comments/add/comments-add.html",'<md-dialog aria-label="Add comment"><md-dialog-content class=md-dialog-content><h2><i class="zmdi zmdi-comment grey"></i> New comment</h2><p>Would you add comment ?</p><textarea data-ng-model=comment style="width: 500px; height: 180px" data-focus-if data-focus-delay=200></textarea></md-dialog-content><md-dialog-actions layout=row layout-align=end><md-button data-ng-click=cancel()>Cancel</md-button><md-button class=md-primary data-ng-disabled=!comment data-ng-click=hide()>Save</md-button></md-dialog-actions></md-dialog>'),a.put("components/comments/comments.html",'<div role=tabpanel id=tab-comments data-ng-init=ctrlComments.init()><md-content class=md-padding layout-fill><div layout=row layout-align="center center"><p data-ng-if="ctrl.ticket.comments.length <= 0">No comment</p></div><md-list data-ng-if="ctrl.ticket.comments.length > 0"><md-list-item data-ng-repeat="comment in ctrl.ticket.comments | orderBy:\'date\':true"><div layout=column><p><i class="zmdi zmdi-account grey"></i> <strong data-ng-bind=comment.user></strong> add comment: <em data-ng-bind="comment.date * 1000 | amDateFormat:\'DD/MM/YY HH:mm\'"></em></p><div><a href=# data-ng-if="ctrlComments.getMe().username === comment.user" editable-textarea=comment.comment e-rows=5 e-cols=70 onaftersave=ctrlComments.updateComment(comment)><pre class=body-content data-ng-bind="comment.comment || \'no comment\'"></pre></a><pre class=body-content data-ng-if="ctrlComments.getMe().username !== comment.user" data-ng-bind="comment.comment || \'No comment\'">\n                        </pre></div></div><md-divider data-ng-if=!$last></md-divider></md-list-item></md-list></md-content></div>'),a.put("components/menu-shortcuts/menu-shortcuts.html",'<div data-ng-controller=MenuShortcutsCtrl><div layout=row layout-align=center data-ng-show=loaders.stats><md-progress-circular md-mode=indeterminate md-theme=white></md-progress-circular></div><div data-ng-show=!loaders.stats><a data-ng-href={{searchMyTickets()}} class=toolbar-shortcuts title="See my tickets" aria-label="See my tickets">My tickets</a> <span class="fs13 no-margin" data-ng-show=!loaders.stats>(</span> <a data-ng-href={{searchMyTicketsAnswered()}} class="toolbar-shortcuts no-margin" title="See my tickets answered" aria-label="See my tickets answered"><span data-ng-bind=stats.myTicketsAnsweredCount></span> answered</a>, <a data-ng-href={{searchMyTicketsTodo()}} class="toolbar-shortcuts no-margin" title="See my tickets todo" aria-label="See my tickets todo"><span data-ng-bind=stats.myTicketsTodoCount></span> todo</a>, <a data-ng-href={{searchMyTicketsSleeping()}} class="toolbar-shortcuts no-margin" title="See my tickets sleeping" aria-label="See my tickets sleeping"><span data-ng-bind=stats.myTicketsSleepingCount></span> sleeping</a> <span class="fs13 no-margin" data-ng-show=!loaders.stats>)</span> <a ui-sref=searchTodo class=toolbar-shortcuts title="See sorted todo tickets" aria-label="See sorted todo tickets">Prioritized tickets (<span data-ng-bind=stats.todoCount></span>)</a></div></div>'),a.put("components/news/dialog-news-add/dialog-news-add.html",'<md-dialog aria-label="Add news" data-ng-init=init() flex><md-dialog-content class=md-dialog-content><h1><i class="mdi mdi-notifications-on grey"></i> Add News</h1><form name=formAddNews><md-content layout=column layout-padding layout-fill><md-input-container><label>Title</label><input required name=newsTitle data-ng-model="news.title"><div ng-messages=formAddNews.newsTitle.$error><div ng-message=required>Enter title.</div></div></md-input-container><md-input-container><label>News content</label><textarea data-ng-model=news.content></textarea></md-input-container></md-content></form></md-dialog-content><md-dialog-actions layout=horizontal layout-align=end><md-button data-ng-click=cancel()>Cancel</md-button><md-button class=md-primary data-ng-click=send() data-ng-disabled="!news.content || !news.title"><i class="mdi mdi-send grey"></i> Send</md-button></md-dialog-actions></md-dialog>'),a.put("components/news/dialog-news-delete/dialog-news-delete.html",'<md-dialog aria-label="Delete news"><md-dialog-content class=md-dialog-content><h1><i class="mdi mdi-notifications-off grey"></i> Delete News</h1><p>Do you want to delete this news ?</p></md-dialog-content><md-dialog-actions layout=horizontal layout-align=end><md-button data-ng-click=cancel()>Cancel</md-button><md-button class=md-primary data-ng-click=delete()><i class="mdi mdi-delete grey"></i> Delete</md-button></md-dialog-actions></md-dialog>'),a.put("components/news/dialog-news-edit/dialog-news-edit.html",'<md-dialog aria-label="Edit news" flex><md-dialog-content class=md-dialog-content><h1><i class="mdi mdi-notifications grey"></i> Edit News</h1><md-content layout=column><md-input-container><label>Title</label><input data-ng-model=news.title required></md-input-container><md-input-container><label>News content</label><textarea data-ng-model=news.content></textarea></md-input-container></md-content></md-dialog-content><md-dialog-actions layout=horizontal layout-align=end><md-button data-ng-click=cancel()>Cancel</md-button><md-button class=md-primary data-ng-click=send() data-ng-disabled="!news.content || !news.title"><i class="mdi mdi-send grey"></i> Send</md-button></md-dialog-actions></md-dialog>'),a.put("components/paste-and-parse/paste-and-parse.html",'<md-dialog aria-label="Paste and parse" data-ng-init=init() flex><md-dialog-content class=md-dialog-content><h1><i class="zmdi zmdi-copy grey"></i> Paste &amp; Parse</h1><md-content layout=column layout-align=center data-ng-show=!parsedData><md-input-container><label>Paste your raw data and leave the rest to me.</label><textarea data-ng-model=rawData></textarea></md-input-container></md-content><md-content layout=column layout-align=center data-ng-show="parsedData && parsedData.length === 0 && !processing"><p>No IP/URL/FQDN found in the pasted data.</p></md-content><md-content layout=column layout-align=center data-ng-show="parsedData && parsedData.length > 0 && !processing"><p>Here are the parsed data :</p><table class="table table-medium table-hover table-items table-mc-indigo"><thead><tr><th data-ng-repeat="(key, val) in parsedData[0]">{{key}}</th><th></th></tr></thead><tbody><tr data-ng-repeat="row in parsedData"><td data-ng-repeat="(key, val) in row">{{val}}</td><td flex=10><a data-ng-click=removeParsedData(row) href=#><i class="zmdi zmdi-close"></i></a></td></tr></tbody></table></md-content><md-content layout=column layout-align=center data-ng-show="parsedData && processing"><p>In progress...</p><table class="table table-medium table-hover table-items table-mc-indigo"><thead><tr><th data-ng-repeat="(key, val) in parsedData[0]">{{key}}</th></tr></thead><tbody><tr data-ng-repeat="row in parsedData"><td data-ng-repeat="(key, val) in row">{{val}}</td></tr></tbody></table></md-content></md-dialog-content><div class=md-actions layout=horizontal layout-align=end><md-button data-ng-click=cancel() data-ng-hide="parsedData && processing">Close</md-button><md-button data-ng-click=displayParsedData() data-ng-show=!parsedData data-ng-disabled=!rawData>Parse</md-button><md-button data-ng-click=processParsedData() data-ng-show="parsedData && parsedData.length > 0 && !processing">Proceed</md-button><md-button data-ng-click=validate() data-ng-show="parsedData && processing">Done</md-button></div></md-dialog>'),
a.put("components/report-items/report-items.html",'<div id=report-items data-ng-controller=ReportItemsCtrl data-ng-init=ctrlItems.init() style="width: 100%"><h4>Items</h4><md-button data-ng-click=ctrlItems.addNewReportItemMode() data-ng-disabled=ctrlItems.addItemMode>+ Add new item</md-button><md-button data-ng-click=ctrlItems.showDialogPasteAndParse()><md-icon md-font-icon="zmdi zmdi-copy"></md-icon>&nbsp;Paste &amp; Parse</md-button><div layout=row style="width: 100%" data-ng-if="!ctrlItems.loaders.items && ctrlItems.items.items.length > 1"><md-input-container md-no-float flex><md-icon md-font-icon="zmdi zmdi-search zmdi-hc-2x grey"></md-icon><input placeholder=Filter data-ng-model=ctrlItems.txtFilterItems data-ng-model-options="{debounce: {\'default\': 500}}" data-ng-change="ctrlItems.getItems()"></md-input-container></div><table class="table table-medium table-hover table-items table-mc-indigo"><thead><tr><th>Type</th><th>Item</th><th>Date</th><th>Reputation</th><th>Actions</th></tr></thead><tbody data-ng-if=ctrlItems.loaders.items><tr><td colspan=5><div layout=row layout-fill layout-align=center><md-progress-circular md-mode=indeterminate class=md-accent></md-progress-circular></div></td></tr></tbody><tbody data-ng-show="!ctrlItems.loaders.items && ctrlItems.items.itemsCount <= 0"><tr><td colspan=5><div layout=row layout-fill layout-align=center>No item</div></td></tr></tbody><tbody data-ng-if=!ctrlItems.loaders.items><tr data-ng-show=ctrlItems.addItemMode><td><select data-ng-model=ctrlItems.newItem.itemType><option value=IP>IP</option><option value=URL>URL</option><option value=FQDN>FQDN</option></select></td><td><a href=# editable-text=ctrlItems.newItem.rawItem onaftersave=ctrlItems.addNewReportItem() buttons=no><md-tooltip>Click to edit this item</md-tooltip>{{ ctrlItems.newItem.rawItem | limitTo: 90 }}{{ctrlItems.newItem.rawItem.length > 90 ? \'...\' : \'\'}}</a></td><td colspan=2></td><td><md-button data-ng-click="ctrlItems.addItemMode = false;ctrlItems.newItem = null" class=md-icon-button aria-label="Add item"><md-tooltip>Cancel</md-tooltip><i class="zmdi zmdi-close grey"></i></md-button></td></tr></tbody><tbody data-ng-repeat="item in ctrlItems.items.items"><tr data-ng-repeat="history in item.history"><td data-ng-bind=item.itemType></td><td><a href=# title="Click to edit" editable-text=item.rawItem onaftersave=ctrlItems.updateReportItem(item) buttons=no data-ng-if="item.history.length === 1"><md-tooltip>Click to edit this item</md-tooltip>{{ history.rawItem | limitTo: 50 }}{{item.rawItem.length > 50 ? \'...\' : \'\'}}</a> <span data-ng-if="item.history.length > 1">{{ item.rawItem | limitTo: 50 }}{{item.rawItem.length > 50 ? \'...\' : \'\'}}</span> <span data-ng-if="item.itemType !== \'IP\'" class=badge data-ng-class="{info: history.ipCategory === \'managed\',\n                                          warning: history.ipCategory === \'cloudlfare\'}">{{history.ip}}</span></td><td>{{ history.date * 1000 | date: \'yyyy-MM-dd HH:mm\' }}</td><td data-ng-if="history.ipCategory !== \'managed\'"></td><td data-ng-if="history.ipCategory === \'managed\'"><div layout=row layout-sm=row layout-align="start start" layout-fill class=no-margin><!-- RBL data --><md-fab-speed-dial md-direction=left class="md-scale reputation"><md-fab-trigger><md-button aria-label=menu class="md-raised md-mini" ng-class="{\'md-warn\': !ctrlItems.isReputationClean(\'rbl\', history.ip)}">RBL<md-progress-circular data-ng-show=!ctrlItems.rbl[history.ip] md-mode=indeterminate class=md-hue-2 md-diameter=10></md-progress-circular></md-button></md-fab-trigger><md-fab-actions class=left><span data-ng-repeat="rbl in ctrlItems.rbl[history.ip]" class="badge ml5" data-ng-class="{success: !rbl.result, error: rbl.result}"><md-tooltip>{{rbl.fullName}}</md-tooltip>{{rbl.shortName}}</span></md-fab-actions></md-fab-speed-dial><!-- Phishing --><md-fab-speed-dial md-direction=left class="md-scale reputation" data-ng-show="item.itemType === \'URL\'"><md-fab-trigger><md-button aria-label=menu class="md-raised md-mini" ng-class="{\'md-warn\': !ctrlItems.isReputationClean(\'checks\', history.ip)}">Phishing<md-progress-circular data-ng-show=!ctrlItems.checks[item.rawItem] md-mode=indeterminate class=md-hue-2 md-diameter=10></md-progress-circular></md-button></md-fab-trigger><md-fab-actions class=right><span data-ng-repeat="check in ctrlItems.checks[item.rawItem]" class="badge ml5" data-ng-class="{success: !check.result, error: check.result}"><md-tooltip>{{check.fullName}}</md-tooltip>{{check.shortName}}</span></md-fab-actions></md-fab-speed-dial></div><div layout=row layout-sm=row layout-align="start start" layout-fill class=no-margin><!-- External system data --><md-fab-speed-dial md-direction=right class="md-scale reputation"><md-fab-trigger><md-button aria-label=menu class="md-raised md-mini" ng-class="{\'md-warn\': !ctrlItems.isReputationClean(\'external\', history.ip)}">External<md-progress-circular data-ng-show=!ctrlItems.external[history.ip] md-mode=indeterminate class=md-hue-2 md-diameter=10></md-progress-circular></md-button></md-fab-trigger><md-fab-actions class=left><span data-ng-repeat="external in ctrlItems.external[history.ip]" class="badge ml5" data-ng-class="{success: external.result === 0, error: external.result > 0}" data-ng-click=ctrlItems.showDialogReputation($event,history,external.shortName) style="cursor: pointer"><md-tooltip>{{external.fullName}}</md-tooltip>{{external.shortName}}({{external.result | number:0}})</span></md-fab-actions></md-fab-speed-dial><!-- Internal system data --><md-fab-speed-dial md-direction=right class="md-scale reputation"><md-fab-trigger><md-button aria-label=menu class="md-raised md-mini" ng-class="{\'md-warn\': !ctrlItems.isReputationClean(\'internal\', history.ip)}">Internal<md-progress-circular data-ng-show=!ctrlItems.internal[history.ip] md-mode=indeterminate class=md-hue-2 md-diameter=10></md-progress-circular></md-button></md-fab-trigger><md-fab-actions class=right><span data-ng-repeat="internal in ctrlItems.internal[history.ip]" class="badge ml5" data-ng-class="{success: !internal.blacklisted && internal.result === 0,\n                                                    info: !internal.blacklisted && internal.result > 0,\n                                                    error: internal.blacklisted}"><md-tooltip>Last event: {{internal.lastEvent}}</md-tooltip>{{internal.shortName}} ({{internal.result}})</span></md-fab-actions></md-fab-speed-dial></div><div layout=row layout-sm=row layout-align="start start" layout-fill class=no-margin><!-- Tool links --><md-fab-speed-dial md-direction=left class="md-scale reputation"><md-fab-trigger><md-button aria-label=menu class="md-raised md-mini">Tools<md-progress-circular data-ng-show=!ctrlItems.tools[history.ip] md-mode=indeterminate class=md-hue-2 md-diameter=10></md-progress-circular></md-button></md-fab-trigger><md-fab-actions class=right><span data-ng-repeat="tool in ctrlItems.tools[history.ip]" class=ml5><a ng-href={{tool.uri}} target=_blank>{{tool.shortName}}</a></span></md-fab-actions></md-fab-speed-dial></div></td><td><md-icon md-font-icon="zmdi zmdi-eye" data-ng-if="item.hasOwnProperty(\'viewed\')" data-ng-class="{grey: !item.viewed, primary: item.viewed}"><md-tooltip data-ng-if=item.viewed>Has been viewed.</md-tooltip><md-tooltip data-ng-if=!item.viewed>Not viewed yet by the defendant.</md-tooltip></md-icon><a href="" data-ng-click=ctrlItems.removeReportItem(item) aria-label="Remove item" class=action-icon><md-tooltip>Remove this item</md-tooltip><md-icon md-font-icon="zmdi zmdi-delete grey"></md-icon></a></td></tr></tbody></table><div class=pagination layout=row layout-align=space-around><paging class=small page=ctrlItems.rootCtrl.currentPageItems page-size=ctrlItems.rootCtrl.resultsItemsPerPage total=ctrlItems.items.itemsCount adjacent=5 dots=... scroll-top=true hide-if-empty=true ul-class=pagination active-class=active disabled-class=disabled show-prev-next=true paging-action="ctrlItems.rootCtrl.currentPageItems = page; ctrlItems.getItems()"></paging><div flex></div><input type=number data-ng-model=ctrlItems.rootCtrl.currentPageItems data-ng-change=ctrlItems.getItems() data-ng-model-options="{debounce: {\'default\': 500}}" data-ng-if="ctrlItems.rootCtrl.round(ctrlItems.items.itemsCount / ctrlItems.rootCtrl.resultsItemsPerPage) > 1" max="{{ctrlItems.rootCtrl.round(ctrlItems.items.itemsCount / ctrlItems.rootCtrl.resultsItemsPerPage)}}" min="1"><md-select data-ng-model=ctrlItems.rootCtrl.resultsItemsPerPage aria-label="Items by page" data-ng-change=ctrlItems.getItems() data-ng-if="ctrlItems.rootCtrl.round(ctrlItems.items.itemsCount / ctrlItems.rootCtrl.resultsItemsPerPage) > 1"><md-option data-ng-show="ctrlItems.items.itemsCount >= 10" value=10>10</md-option><md-option data-ng-show="ctrlItems.items.itemsCount >= 15" value=15>15</md-option><md-option data-ng-show="ctrlItems.items.itemsCount >= 20" value=20>20</md-option><md-option data-ng-show="ctrlItems.items.itemsCount >= 50" value=50>50</md-option><md-option data-ng-show="ctrlItems.items.itemsCount >= 100" value=100>100</md-option></md-select></div><md-divider></md-divider></div>'),a.put("components/services/services.html",'<div role=tabpanel id=tab-services data-ng-init=ctrlServices.init()><md-content layout=row layout-align="center center" class=md-padding data-ng-if="!ctrl.ticket.defendant && !ctrl.report.defendant"><p>No customer information</p></md-content><md-content layout=row layout-align="center center" class=md-padding data-ng-show=ctrlServices.loaders.services><md-progress-circular md-mode=indeterminate class=md-accent></md-progress-circular></md-content><md-content layout=row layout-align="center center" class=md-padding data-ng-if="!ctrlServices.loaders.services && !ctrlServices.customerServices.expired"><p>No service found</p></md-content><md-content layout=column layout-fill class=md-padding data-ng-repeat="(worldPart, data) in ctrlServices.customerServices.services" data-ng-if="!ctrlServices.loaders.services && ctrlServices.customerServices.count[worldPart] > 0"><md-toolbar md-theme=white class=no-shadow><h3 class=md-toolbar-tools layout=row layout-align=space-between><span class="zmdi zmdi-storage grey"></span> <span flex>Services {{::worldPart}}</span><div flex></div><span data-ng-bind=::ctrlServices.customerServices.count[worldPart]></span></h3></md-toolbar><md-divider></md-divider><md-content class="md-whiteframe-z1 service-sheet" layout-padding layout-margin data-ng-repeat="(serviceName, services) in ctrlServices.customerServices.services[worldPart]" data-ng-class="{expanded: ex.show}"><div layout=row><p><strong data-ng-bind=::serviceName></strong>: {{::services.length}}</p><div flex></div><md-button data-ng-click="ex.show = !ex.show" class=md-icon-button title="Show details" aria-label="Show details" md-no-ink><md-icon md-font-icon="zmdi zmdi-chevron-down zmdi-hc-2x grey" data-ng-class="{\'btn-expanded\': ex.show}"></md-icon></md-button></div><p data-ng-if=ctrlServices.customerServices.expired[worldPart][serviceName].avg>Time average : <strong data-ng-bind=::ctrlServices.customerServices.expired[worldPart][serviceName].avg></strong> days</p><p data-ng-if="ctrlServices.customerServices.expired[worldPart][serviceName].expiredSinceAbuse > 0">Expired since abuse : <strong data-ng-bind=ctrlServices.customerServices.expired[worldPart][serviceName].expiredSinceAbuse></strong></p><div class="serviceDetails table-responsive-vertical" data-ng-if=ex.show><table class="table table-medium table-hover table-mc-indigo"><thead><tr><th>Ref</th><th>Domain</th><th>Creation</th><th>Expiration</th><th>Auto-renew</th><th>State</th></tr></thead><tbody data-ng-show=ctrlServices.loaders.services><tr><td colspan=6><div layout=row layout-fill layout-align=center><md-progress-circular md-mode=indeterminate class=md-accent></md-progress-circular></div></td></tr></tbody><tbody><tr data-ng-repeat="service in ::services | orderBy:\'creationDate\':true" data-ng-class="{expired: service.isExpired}"><td data-title=Ref data-ng-bind=::service.reference></td><td data-title=Domain data-ng-bind=::service.name></td><td data-title=Creation data-ng-bind="::service.creationDate * 1000 | amDateFormat:\'DD/MM/YY HH:mm\'"></td><td data-title=Expiration data-ng-bind="::service.expirationDate * 1000 | amDateFormat:\'DD/MM/YY HH:mm\'"></td><td data-title=Auto-renew data-ng-bind=::service.autorenew></td><td data-title=State data-ng-bind=::service.state></td></tr></tbody></table></div><div data-ng-if="services.length > 10 && ex && ex.show" layout=row layout-align=end><md-button data-ng-click="ex.show = false" title="Hide details" aria-label="Hide details" md-no-ink><i class="zmdi zmdi-chevron-down zmdi-hc-2x grey" class=md-icon-button data-ng-class="{\'btn-expanded\': ex.show}"></i></md-button></div></md-content></md-content></div>')}]);
